#+TITLE: 回帰分析
#+SUBTITLE: 予測と発展的なモデル
#+AUTHOR: 村田 昇
#+EMAIL: noboru.murata@eb.waseda.ac.jp
#+DATE: 2020.10.23
:reveal:
#+INCLUDE: "./reveal.js/org/mycourse.org"
#+STARTUP: hidestars content
# C-c C-x C-v でinlineを切り替え
# <m C-i でlatex block (math env用)
# C-c '
:end:

#+begin_src R :eval no :exports none :tangle yes
  ### 第05回 練習問題解答例
#+end_src
#+begin_src R :exports none
  setwd("~/Desktop/lectures/u-tokyo/autumn/slide")
#+end_src

* モデルの評価
** \(F\)-統計量
   - *ばらつきの比に関する定理*: 
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \text{(F-統計量)}\quad
       F=
       \frac{\frac{1}{p}S_{r}}{\frac{1}{n{-}p{-}1}S}
     %  =\frac{\frac{1}{p}\sum_{i=1}^n(\hat{y}_i-\bar{y})^2}
     %  {\frac{1}{n{-}p{-}1}\sum_{i=1}^n(y_i-\hat{y}_i)^2}
       =\frac{n{-}p{-}1}{p}\frac{R^2}{1-R^2}
     \end{equation}
     #+end_src
     $\beta_1=\dotsb=\beta_p=0$ ならば，
     *\(F\)-統計量* は自由度 $p,n{-}p{-}1$ の $F$ 分布に従う
     #+end_quote
   - 証明には以下の性質を用いる:
     - $S_{r}$ と $S$ は独立となる
     - $S_{r}/\sigma^2$ は自由度 $p$ の $\chi^{2}$ 分布に従う
     - $S/\sigma^2$ は自由度 $n{-}p{-}1$ の $\chi^{2}$ 分布に従う

** \(F\)-統計量を用いた検定
   - 説明変数のうち1つでも役に立つか否かを検定:
     - 帰無仮説: $\beta_1=\dotsb=\beta_p=0$ 
       ($S_r$ が $\chi^2$ 分布になる)
     - 対立仮説: $\exists j\;\beta_j\neq0$
   - \(p\)-値: 確率変数の値が $F$ を超える確率
     #+begin_quote
     #+begin_src latex
       \begin{equation}
         \text{($p$-値)}
         =
         \int_{F}^\infty f(x)dx
         \quad\text{(片側検定)}
       \end{equation}
     #+end_src
     $f(x)$ は自由度 $p,n{-}p{-}1$ の $F$ 分布の確率密度関数
     #+end_quote
     - 帰無仮説 $\forall j\;\beta_j=0$ が正しければ $p$ 値は小さくならない

   # - $F$ 統計量による仮説検証:
   #   #+begin_src latex
   #   \begin{equation}
   #     H_0:\beta_1=\dotsb=\beta_p=0
   #     \quad\text{vs}\quad
   #     H_1:\exists j\;\beta_j\neq
   #   \end{equation}
   #   #+end_src

** COMMENT 演習: \(F\)-統計量
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - [[./code/05-fstat.r][05-fstat.r]] を確認してみよう

** COMMENT 演習
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - 先週用いたデータの回帰分析の結果を，
     寄与率・標準誤差・ \(t\)-統計量・ \(F\)-統計量の観点から
     評価してみよう
     - datasets::airquality
     - datasets::LifeCycleSavings
   - 人工データを用いた数値実験によって
     推定量，\(t\)-統計量，\(F\)-統計量の分布を調べてみよう

** 練習問題
   :PROPERTIES:
   :reveal_background: #fef4f4
   :END:
   - 数値実験により
     \(F\)-統計量の性質を確認しなさい
     - 人工データを用いて\(F\)-統計量の分布を確認しなさい
       #+begin_src R :eval no
         ### f-統計量とその自由度は以下のようにして取り出せる
         est <- lm(formula, data)
         summary(est)$fstat
         summary(est)$fstatistic # 省略しない場合
       #+end_src
     - 広告費と売上データのモデルの有効性を議論しなさい
     - 東京の気候データのモデルの有効性を議論しなさい
     #+begin_src R :eval no :exports none :tangle yes
       ### 練習4
       ### F-統計量の性質

       ### 人工データによる確認
       set.seed(2525) # 乱数のシード (適宜変更せよ)

       ## 試行の設定 (重回帰，以下適宜変更せよ)
       xobs1 <- c(1, 20, 13, 9, 5, 15, 19, 8, 3, 4) # 説明変数1
       xobs2 <- c(3, 19, 1, 4, 18, 7, 2, 10, 6, 12) # 説明変数2
       beta0 <- -1 # 切片 
       beta1 <-  0 # x1の係数 
       beta2 <-  0 # x2の係数 < 係数のどちらも0なので帰無仮説が成り立つ
       sigma <-  sqrt(2) # 誤差の標準偏差(分散の平方根)
       myTrial <- function(){ 
           epsilon <- rnorm(length(xobs1),sd=sigma) # 誤差項
           yobs <- beta0 + beta1*xobs1 + beta2*xobs2 + epsilon # 目的変数
           dat <- data.frame(x1=xobs1,x2=xobs2,y=yobs) # データフレームの作成
           est <- lm(y ~ x1 + x2, data=dat) # 回帰係数の推定
           return(summary(est)$fstat[1]) # F-統計量を返す
       }

       ## 数値実験 (帰無仮説が成り立つ場合)
       mc <- 5000 # 実験回数
       myData <- data.frame( # 1次元の場合はそのままデータフレームが作成できる
           fstat=replicate(mc, myTrial()))
       
       ## モデルのF-統計量の分布
       n <- length(xobs1) # データ数
       p <- 2 # 説明変数の次元
       hist(myData[[1]], # 実験により得られたF-統計量の分布
            breaks=30, freq=FALSE, # 密度で表示
            border="blue", col="lightblue",
            xlab="F statistic", main="null hypothesis is true")
       curve(df(x,df1=p,df2=n-p-1), # 自由度 p, n-p-1 のF-分布
             col="orchid", lwd=2, add=TRUE)

       ## 数値実験 (帰無仮説が成り立たない場合)
       beta1 <-  2 # x1の係数 < 帰無仮説が成り立たない
       myData <- data.frame(
           fstat=replicate(mc, myTrial()))
       
       ## モデルのF-統計量の分布は帰無分布に従わない
       hist(myData[[1]], # 実験により得られたF-統計量の分布
            breaks=30, freq=FALSE, # 密度で表示
            border="blue", col="lightblue",
            xlab="F statistic", main="null hypothesis is false")
       curve(df(x,df1=p,df2=n-p-1), # 自由度 p, n-p-1 のF-分布
             col="orchid", lwd=2, add=TRUE)

       ### 広告費と売上データによる分析の例
       ## データの読み込み
       Adv.data <- read.csv("data/Advertising.csv",
                            row.names=1) # 1列目を行名として読み込む
       ## 説明変数1つのモデルを検討する
       summary(lm(sales ~ TV, data=Adv.data)) 
       summary(lm(sales ~ radio, data=Adv.data)) 
       summary(lm(sales ~ newspaper, data=Adv.data))
       ## radio, newspaper は決定係数は小さく説明力は無いが，
       ## F-stat はそれなりに小さいのでモデルの有効性は無いとは言えない
       
       ### 東京の気候データによる分析の例
       ## データの整理 (8月のデータの抽出)
       TW.subset <- subset(read.csv("data/tokyo_weather_reg.csv"), 
                           subset= months(as.Date(date),
                                          abbreviate=TRUE)==" 8")
       ## press, solar, rain によるモデルを検討する
       summary(lm(temp ~ press, data=TW.subset))
       summary(lm(temp ~ press + solar, data=TW.subset))
       summary(lm(temp ~ press + solar + rain, data=TW.subset))
       ## press のみではモデルの有効性があるとは言えないが
       ## solar と組み合わせることにより有効性が確認できる
       ## rain を加えても press の係数に変化は見られないが
       ## solar の係数が変化し決定係数が大きくなることから
       ## solar と rain が相補的にモデルの精度を上げていることが示唆される
     #+end_src


* 講義の予定
  - 第1日: 回帰モデルの考え方と推定
  - 第2日: モデルの評価
  - *第3日: モデルによる予測と発展的なモデル*


* 回帰分析の復習
** 線形回帰モデル
   - *目的変数* を *説明変数* で説明する関係式を構成:
     - 説明変数: $x_1,\dotsc,x_p$ (p次元)
     - 目的変数: $y$ (1次元)
   - *回帰係数* $\beta_0,\beta_1,\dotsc,\beta_p$ を用いた一次式:
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       y=\beta_0+\beta_1x_1+\dotsb+\beta_px_p
     \end{equation}
     #+end_src
     #+end_quote
   - *誤差項* を含む確率モデルで観測データを表現:
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       y_i=\beta_0+\beta_1 x_{i1}+\cdots+\beta_px_{ip}+\epsilon_i
       \quad (i=1,\dotsc,n)
     \end{equation}
     #+end_src
     #+end_quote

** 問題設定
   - 確率モデル:
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \boldsymbol{y}
       =X\boldsymbol{\beta}+\boldsymbol{\epsilon}
     \end{equation}
     #+end_src
     #+end_quote
   - 式の評価: *残差平方和* の最小による推定
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       S(\boldsymbol{\beta})
       =(\boldsymbol{y}-X\boldsymbol{\beta})^{\mathsf{T}}
       (\boldsymbol{y}-X\boldsymbol{\beta})
     \end{equation}
     #+end_src
     #+end_quote

** 解
   - 解の条件: *正規方程式*
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       X^{\mathsf{T}}X\boldsymbol{\beta}
       =X^{\mathsf{T}}\boldsymbol{y}
     \end{equation}
     #+end_src
     #+end_quote
   - 解の一意性: *Gram 行列* $X^{\mathsf{T}}X$ が正則
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \hat{\boldsymbol{\beta}}
       =
       (X^{\mathsf{T}}X)^{-1}
       X^{\mathsf{T}}\boldsymbol{y}  
     \end{equation}
     #+end_src
     #+end_quote

** 寄与率
   - *決定係数* (R-squared):
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       R^2
       =
       1-\frac{\sum_{i=1}^n\hat{\epsilon}_i^2}{\sum_{i=1}^n(y_i-\bar{y})^2}
     \end{equation}
     #+end_src
     #+end_quote
   - *自由度調整済み決定係数* (adjusted R-squared):
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \bar{R}^2
       =
       1-\frac{\frac{1}{n{-}p{-}1}\sum_{i=1}^n\hat{\epsilon}_i^2}
       {\frac{1}{n{-}1}\sum_{i=1}^n(y_i-\bar{y})^2}
     \end{equation}
     #+end_src
     #+end_quote

** \(t\)-統計量による検定
   - 回帰係数 $\beta_j$ が回帰式に寄与するか否かを検定する
     - 帰無仮説: $\beta_j=0$
     - 対立仮説: $\beta_j\neq0$ ($\beta_j$ は役に立つ)
   - \(t\)-統計量: 各係数ごと，$\xi$ は $(X^{\mathsf{T}} X)^{-1}$ の対角成分
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       t=\frac{\hat{\beta}_j}{\hat{\sigma}\sqrt{\xi_j}}
     \end{equation}
     #+end_src
     #+end_quote
   - $p$ -値: 自由度 $n{-}p{-}1$ の $t$ 分布を用いて計算
     # #+begin_src latex
     # \begin{equation}
     #   \text{($p$-値)}
     #   =
     #   2\int_{|t|}^\infty f(x)dx
     # \end{equation}
     # #+end_src

** \(F\)-統計量による検定
   - 説明変数のうち1つでも役に立つか否かを検定する
     - 帰無仮説: $\beta_1=\dotsb=\beta_p=0$
     - 対立仮説: $\exists j\;\beta_j\neq0$ (少なくとも1つは役に立つ)
   - \(F\)-統計量: 決定係数(または残差)を用いて計算
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       F
       =\frac{n{-}p{-}1}{p}\frac{R^2}{1-R^2}
     \end{equation}
     #+end_src
     #+end_quote
   - $p$ -値: 自由度 $p,n{-}p{-}1$ の $F$ 分布で計算
     # #+begin_src latex
     #   \begin{equation}
     #     \text{($p$-値)}
     #     =
     #     \int_{F}^\infty f(x)dx,
     #   \end{equation}
     # #+end_src

** COMMENT 演習: 回帰分析とその評価
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - [[./code/06-wine.r][06-wine.r]] を確認してみよう


* 回帰モデルによる予測
** 予測
   - 新しいデータ (説明変数) $\boldsymbol{x}$ に対する予測値
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \hat{y}
       =
       (1,\boldsymbol{x}^{\mathsf{T}})\hat{\boldsymbol{\beta}},
       \qquad
       \hat{\boldsymbol{\beta}}
       =
       (X^{\mathsf{T}}X)^{-1}
       X^{\mathsf{T}}\boldsymbol{y}
     \end{equation}
     #+end_src
     #+end_quote
   - 予測値は元データの目的変数の重み付け線形和
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \hat{y}
       =
       \boldsymbol{w}(\boldsymbol{x})^{\mathsf{T}}\boldsymbol{y}
     \end{equation}
     #+end_src
     #+end_quote
   # - これは最小二乗推定量が
   #   #+begin_src latex
   #   \begin{equation}
   #     \hat{\boldsymbol{\beta}}
   #     =
   #     (X^{\mathsf{T}}X)^{-1}
   #     X^{\mathsf{T}}\boldsymbol{y}
   #   \end{equation}
   #   #+end_src
   #   であることから，容易に以下の表現が得られる
   - 重みは元データと新規データの説明変数で決定
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \boldsymbol{w}(\boldsymbol{x})^{\mathsf{T}}
       =
       (1,\boldsymbol{x}^{\mathsf{T}})
       (X^{\mathsf{T}}X)^{-1}
       X^{\mathsf{T}}
     \end{equation}
     #+end_src
     #+end_quote
     
** 予測値の分布
   - 推定量は以下の性質をもつ多変量正規分布
     #+begin_quote
     #+begin_src latex
     \begin{align}
       \mathbb{E}[\hat{\boldsymbol{\beta}}]
       &=\boldsymbol{\beta}\\
       \mathrm{Cov}(\hat{\boldsymbol{\beta}})
       &=\sigma^{2}(X^{\mathsf{T}}X)^{-1}
     \end{align}
     #+end_src
     #+end_quote
   - この性質を利用して以下の3つの値の違いを評価
     #+begin_quote
     #+begin_src latex
     \begin{align}
       \hat{y}&=(1,\boldsymbol{x}^{\mathsf{T}})\hat{\boldsymbol{\beta}}
       &&\text{(回帰式による予測値)}\\
       \tilde{y}&=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}
       &&\text{(最適な予測値)}\\
       y&=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}+\epsilon
       &&\text{(観測値)}
     \end{align}
     #+end_src
     ($\hat{y}$ と $y$ は独立な正規分布に従うことに注意)
     #+end_quote

** 最適な予測値との差
   - 差の分布は以下の平均・分散の正規分布
     #+begin_quote
     #+begin_src latex
       \begin{align}
	 \check{\boldsymbol{x}}^{\mathsf{T}}&=(1,\boldsymbol{x}^{\mathsf{T}})\\
	 \mathbb{E}[\tilde{y}-\hat{y}]
	 &=\check{\boldsymbol{x}}^{\mathsf{T}}\boldsymbol{\beta}
	   -\check{\boldsymbol{x}}^{\mathsf{T}}
	   \mathbb{E}[\hat{\boldsymbol{\beta}}]
	   =0\\
	 \mathrm{Var}(\tilde{y}-\hat{y})
	 &=\underbrace{\sigma^{2}\check{\boldsymbol{x}}^{\mathsf{T}}
	   (X^{\mathsf{T}}X)^{-1}\check{\boldsymbol{x}}
	   }_{\text{$\hat{\boldsymbol{\beta}}$の推定誤差による分散}}
	   =\sigma^{2}\gamma_{c}(\boldsymbol{x})^{2}
       \end{align}
     #+end_src
     #+end_quote
   - 正規化による表現
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \frac{\tilde{y}-\hat{y}}{\sigma\gamma_{c}(\boldsymbol{x})}
       \sim \mathcal{N}(0,1)
     \end{equation}
     #+end_src
     #+end_quote

** 信頼区間
   - 未知の分散を不偏分散で推定
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       Z=
       \frac{\tilde{y}-\hat{y}}{\hat{\sigma}\gamma_{c}(\boldsymbol{x})}
       \sim \mathcal{T}(n{-}p{-}1) 
       \quad (\text{$t$-分布})
     \end{equation}
     #+end_src
     #+end_quote
   - 確率 $\alpha$ の信頼区間 
     (最適な予測値 $\tilde{y}$ が入ることが期待される区間)
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \left(
	 \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x}),\;
	 \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x})
       \right)
     \end{equation}
     #+end_src
     ただし $C_{\alpha}$ は以下を満たす定数
     #+begin_src latex
     \begin{equation}
       P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
       =\alpha
     \end{equation}
     #+end_src
     #+end_quote
#   - 確率 $\alpha$ で最適な予測値 $\tilde{y}$ が入ることが期待される区間

** 観測値との差
   - 差の分布は以下の平均・分散の正規分布
     #+begin_quote
     #+begin_src latex
     \begin{align}
       \mathbb{E}[y-\hat{y}]
       &=\check{\boldsymbol{x}}^{\mathsf{T}}\boldsymbol{\beta}
	 -\check{\boldsymbol{x}}^{\mathsf{T}}
         \mathbb{E}[\hat{\boldsymbol{\beta}}]
	 =0\\
       \mathrm{Var}(y-\hat{y})
       &=\underbrace{\sigma^{2}\check{\boldsymbol{x}}^{\mathsf{T}}
	 (X^{\mathsf{T}}X)^{-1}\check{\boldsymbol{x}}
	 }_{\text{$\hat{\boldsymbol{\beta}}$の推定誤差による分散}}
	 +\underbrace{\sigma^{2}}_{\text{誤差の分散}}
         =\sigma^{2}\gamma_{p}(\boldsymbol{x})^{2}
     \end{align}
     #+end_src
     #+end_quote
   - 正規化による表現
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \frac{y-\hat{y}}{\sigma\gamma_{p}(\boldsymbol{x})}
       \sim \mathcal{N}(0,1)
     \end{equation}
     #+end_src
     #+end_quote

** 予測区間
   - 未知の分散を不偏分散で推定
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       Z=
       \frac{y-\hat{y}}{\hat{\sigma}\gamma_{p}(\boldsymbol{x})}
       \sim \mathcal{T}(n{-}p{-}1) 
       \quad (\text{$t$-分布})
     \end{equation}
     #+end_src
     #+end_quote
   - 確率 $\alpha$ の予測区間
     (観測値 $y$ が入ることが期待される区間)
     #+begin_quote
     #+begin_src latex
     \begin{equation}
       \left(
	 \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x}),\;
	 \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x})
       \right)
     \end{equation}
     #+end_src
     ただし $C_{\alpha}$ は以下を満たす定数
     #+begin_src latex
     \begin{equation}
       P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
       =\alpha
     \end{equation}
     #+end_src
     #+end_quote
#   - 確率 $\alpha$ で観測値 $y$ が入ることが期待される区間
   - $\gamma_{p}>\gamma_{c}$ なので信頼区間より広くなる

** R: モデルからの予測
   - 関数 ~predict()~ を用いた予測:
     #+begin_src R :eval no
       ## モデルの作成
       train <- data.frame(x1=..., x2=..., y=...)
       est  <- lm(y ~ x1 + x2, data=train) 
       fit  <- predict(est) # あてはめ値の計算
       ## 新しいデータの予測
       test <- data.frame(x1=..., x2=...) # 予測したいデータの説明変数
       pred <- predict(est, # 予測値の計算
                       newdata=test) # 説明変数のデータフレーム
       cint <- predict(est, newdata=test, 
                       interval="confidence", level=0.95) # 信頼区間
       pint <- predict(est, newdata=test, 
                       interval="prediction", level=0.95) # 予測区間
       ## 信頼区間，予測区間の水準の既定値は0.95
     #+end_src
** R: 予測の例
   - 東京の気候データによる例:
     #+begin_src R :eval no :tangle yes
       ### 9,10月のデータでモデルを構築し，8,11月のデータを予測
       TW.data <- transform(read.csv("data/tokyo_weather_reg.csv"),
                            month=as.numeric(months(as.Date(date), # 月(数値)を付加
                                                    abbreviate=TRUE)))
       TW.model <- temp ~ solar + press # モデルの定義 
       TW.train <- subset(TW.data, # モデル推定用データ
                          subset= month %in% c(9,10))
       TW.test  <- subset(TW.data, # 予測用データ
                          subset= month %in% c(8,11))
       TW.est <- lm(TW.model, data=TW.train) # モデルの推定
       summary(TW.est) # モデルの評価
       ## 予測値の計算
       TW.fit  <- predict(TW.est) # データのあてはめ値
       TW.pred <- predict(TW.est, # 新規データの予測値
                          newdata=TW.test) 
     #+end_src
     #+begin_src R :eval no :exports none :tangle yes
       ## 予測結果を図示
       myColor <- rep("black",12) 
       myColor[8:11] <- c("red","orange","violet","blue") # 色の定義
       with(TW.train,
            plot(temp ~ TW.fit, pch=1, col=myColor[month],
                 xlab="fitted", ylab="observed"))
       with(TW.test,
            points(temp ~ TW.pred, pch=4, col=myColor[month]))
       abline(0,1,col="gray") # 予測が完全に正しい場合のガイド線
       legend("bottomright",inset=.05, pch=15, # 凡例の作成
              legend=c("Aug","Sep","Oct","Nov"), col=myColor[8:11])
     #+end_src

** COMMENT 演習: 信頼区間と予測区間
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - [[./code/06-interval.r][06-interval.r]] を確認してみよう
** COMMENT 演習: モデルの更新
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - [[./code/06-model.r][06-model.r]] を確認してみよう

** 練習問題
   :PROPERTIES:
   :reveal_background: #fef4f4
   :END:
   - 東京の気候データを用いて以下の実験を試みなさい
     - 8月のデータで回帰式を推定する
     - 上記のモデルで9月のデータを予測する
     #+begin_src R :eval no
       ## 8月と9月のデータを取り出すには，例えば以下のようにすればよい
       TW.data <- transform(read.csv("data/tokyo_weather_reg.csv"),
			    month=as.numeric(months(as.Date(date), 
						    abbreviate=TRUE)))
       TW.model <- temp ~ solar + press + cloud # モデルの定義 
       TW.train <- subset(TW.data, subset= month==8) # 推定用データ
       TW.test  <- subset(TW.data, subset= month %in% 9) # 予測用データ
       ## %in% は集合に含まれるかを検査する
       ## 例えば7月，9月を抽出するには month %in% c(7,9)
     #+end_src
   - 人工データを作成してモデルの予測について検討しなさい (宿題)
     #+begin_src R :eval no :exports none :tangle yes
       ### 練習1
       ### 回帰式を用いた予測

       ### 東京の気候データによる分析
       ## 信頼区間と予測区間の計算
       require(plotrix) # 区間付きのグラフを利用するため
       TW.data <- transform(read.csv("data/tokyo_weather_reg.csv"),
			    date=as.Date(date), # 日付をx軸で使えるように変換
			    month=as.numeric(months(as.Date(date), 
						    abbreviate=TRUE)))
       TW.model <- temp ~ solar + press + cloud # モデルの定義 
       TW.train <- subset(TW.data, subset= month %in% 8) # 推定用データ
       TW.test  <- subset(TW.data, subset= month %in% 9) # 予測用データ
       TW.est <- lm(TW.model, data=TW.train) # モデルの推定
       ## 信頼区間
       TW.fit <- data.frame(TW.train,
                            predict(TW.est, # 回帰式によるあてはめ値を付加
                                    interval="confidence")) 
       TW.cint <- data.frame(TW.test,
                             predict(TW.est, newdata=TW.test,
                                     interval="confidence"))
       ## 予測区間
       TW.pint <- data.frame(TW.test,
                             predict(TW.est, newdata=TW.test,
                                     interval="prediction"))

       ## 8月のデータで8月をあてはめた信頼区間
       with(TW.fit, { # 2つのプロットをまとめて実行
           plotCI(date, fit, ui=upr, li=lwr, # それぞれの列名に注意
                  col="blue", scol="lightblue",
                  xlab="August", ylab="temperature")
           points(date, temp, col="red", pch=16)
       })
       
       ## 8月のデータで9月をあてはめた信頼区間
       with(TW.cint, {
           plotCI(date, fit, ui=upr, li=lwr, ylim=c(20,32), 
                  col="blue", scol="lightblue", 
                  xlab="September", ylab="temperature")
           points(date, temp, col="red", pch=16)
       })

       ## 8月のデータで9月をあてはめた予測区間
       with(TW.pint, {
           plotCI(date, fit, ui=upr, li=lwr, ylim=c(20,32),
                  col="blue", scol="lightblue",
                  xlab="September", ylab="temperature")
           points(date, temp, col="red", pch=16)
       })

       ### 人工データによる検討例
       ###   以下はあくまで例です
       ###   自由に数値実験を設計して下さい

       ## 試行の設定
       ## モデル: y = -1 + 2*x1
       ## 人工データの生成
       set.seed(1313) # 乱数のシード
       n <- 50 # データ数の設定
       xobs1 <- runif(n) # 説明変数1
       xobs2 <- runif(n) # 説明変数2
       beta0 <- -1 # 切片 
       beta1 <-  2 # xの係数
       beta2 <-  0 # xの係数
       sigma <-  1/2 # 誤差の標準偏差
       epsilon <- rnorm(length(xobs1),sd=sigma) # 誤差項
       yobs <- beta0 + beta1*xobs1 + beta2*xobs2 + epsilon # 目的変数
       myTrain <- data.frame(x1=xobs1,
			    x2=xobs2,
			    y=yobs) # データフレームの作成
       est1 <- lm(y ~ x1, data=myTrain) # x1による回帰分析の実行(正しいモデル)
       summary(est1)
       est2 <- lm(y ~ x1 + x2, data=myTrain) # x1とx2による回帰分析の実行(冗長なモデル)
       summary(est2)
       est3 <- lm(y ~ x2, data=myTrain) # x2による回帰分析の実行(誤ったモデル)
       summary(est3)

       ## 新規データに対する予測
       myTest <- data.frame(x1=runif(n),
			     x2=runif(n,-10,10)) # 説明変数の新規データ
       ynew <- beta0 + beta1*myTest$x1 # 新規データに対する目的変数の真値 (誤差なし)
       yhat1 <- predict(est1, newdata=myTest) # est1による予測値
       yhat2 <- predict(est2, newdata=myTest) # est2による予測値
       yhat3 <- predict(est3, newdata=myTest) # est3による予測値

       ## 散布図による可視化
       plot(ynew ~ yhat1, 
	    col="red", pch=20,
	    xlab="fitted value", ylab="observed value") # 黒
       points(ynew ~ yhat2, pch=20, col="green")  # 赤
       points(ynew ~ yhat3, pch=20, col="blue") # 青
       abline(0,1, col="gray") # 理想的な結果
       legend("bottomright",inset=.05, # 凡例の作成
	      col=c("red","green","blue"), pch=c(20,20,20), 
	      legend=c("model1","model2","model3"))

       ## 相関係数による数値的な評価 (R-squared と等価)
       cor(ynew, yhat1)^2 
       cor(ynew, yhat2)^2
       cor(ynew, yhat3)^2
     #+end_src


* 非線形の関係
** 非線形な関係のモデル化
   - 目的変数 $Y$
   - 説明変数 $X_1,\dotsc,X_p$
   - 説明変数の追加で対応可能
     - 交互作用 (交差項): $X_iX_j$ のような説明変数の積
     - 非線形変換: $\log(X_k)$ のような関数による変換

** R: 線形でないモデル式の書き方
   - 交互作用を記述するためには特殊な記法がある
   - 非線形変換はそのまま関数を記述すればよい
   - 1つの変数の多項式は関数 ~I()~ を用いる
     #+begin_src R :eval no
       ## 目的変数 Y, 説明変数 X1,X2,X3
       ## 交互作用を含む式 (formula) の書き方
       Y ~ X1 + X1:X2       # X1 + X1*X2
       Y ~ X1 * X2          # X1 + X2 + X1*X2
       Y ~ (X1 + X2 + X3)^2 # X1 + X2 + X3 + X1*X2 + X2*X3 + X3*X1
       ## 非線形変換を含む式 (formula) の書き方
       Y ~ f(X1)            # f(X1) (fは任意の関数)
       Y ~ X1 + I(X2^2)     # X1 + X2^2
     #+end_src

** COMMENT 演習: 交互作用
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - [[./code/06-cross.r][06-cross.r]] を確認してみよう


** 練習問題
   :PROPERTIES:
   :reveal_background: #fef4f4
   :END:
   - 東京の気候データ(9-11月)を用いて
     気温を回帰する以下のモデルを検討しなさい
     - 日射量，気圧，湿度の線形回帰モデル
     - 湿度の対数を考えた線形回帰モデル
     - 最初のモデルにそれぞれの交互作用を加えたモデル
     - 更に3つの変数の積を加えたモデル
     - 自由にモデルを設定してみよ
     #+begin_src R :eval no :exports none :tangle yes
       ### 練習2
       ### 交互作用と非線形を含む回帰

       ### 東京の気候データによる分析
       ## データの整形
       TW.subset <- subset(TW.data, subset= month %in% 9:11)

       ## 日射量，気圧，湿度の線形回帰モデル
       summary(lm(temp ~ solar + press + humid, data=TW.subset))
       ## 湿度の対数を考えた線形回帰モデル
       summary(lm(temp ~ solar + press + log(humid), data=TW.subset))
       ## 最初のモデルにそれぞれの交互作用を加えたモデル (書き方はいろいろある)
       summary(lm(temp ~ (solar + press + humid)^2, data=TW.subset))
       ## 更に3つの変数の積を加えたモデル
       summary(lm(temp ~ solar * press * humid, data=TW.subset))

       ## 用いた変数の散布図
       plot(~ temp + solar + press + humid, data=TW.subset)
       ## 最後のモデルの視覚的な評価 (診断プロット)
       plot(lm(temp ~ solar * press * humid, data=TW.subset))
     #+end_src

* カテゴリカル変数
** カテゴリカル変数
   - 悪性良性や血液型などの数値ではないデータ
   - 適切な方法で数値に変換して対応:
     - 2値の場合は0,1を割り当てる
       - 悪性:1
       - 良性:0
     - 3値以上の場合は *ダミー変数* を利用する (カテゴリ数-1個)
       - A型: (1,0,0)
       - B型: (0,1,0)
       - O型: (0,0,1)
       - AB型: (0,0,0)

** R: カテゴリカル変数の取り扱い
   - 何も宣言しなくても通常は適切に対応してくれる
   - 陽にカテゴリカル変数として扱いたい場合は関数 ~factor()~ を利用:
     #+begin_src R :eval no :tangle yes
       ## factor属性の与え方
       X <- c("A","S","A","B","D")
       Y <- c(85,100,80,70,30)
       dat1 <- data.frame(X,Y)
       dat2 <- transform(dat1, 
                         X2=factor(X))
       str(dat2) # 作成したデータフレームの素性を見る
       dat3 <- transform(dat2, 
                         X3=factor(X, levels=c("S","A","B","C","D")))
       str(dat3) # dat2とはfactorの順序が異なる
       dat4 <- transform(dat2,
                         Y2=factor(Y > 60)) 
       str(dat4) # 条件の真偽で2値に類別される
     #+end_src

** COMMENT 演習: ダミー変数
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - [[./code/06-dummy.r][06-dummy.r]] を確認してみよう


** 練習問題
   :PROPERTIES:
   :reveal_background: #fef4f4
   :END:
   - 東京の気候データ(1年分)を用いて
     気温を回帰する以下のモデルを検討しなさい
     - 降水の有無を表すカテゴリカル変数を用いたモデル \\
       (雨が降ると気温が変化することを検証するモデル)
     - 月をカテゴリカル変数として加えたモデル \\
       (月毎の気温の差を考慮して検証するモデル)
     #+begin_src R :eval no :exports none :tangle yes
       ### 練習3
       ### カテゴリカル変数

       ### 東京の気候データによる分析
       ## 雨と気温の関係を分析
       TW.data <- transform(TW.data,
                            rain=factor(rain > 0)) 
       summary(lm(temp ~ rain, data=TW.data))
       ## 通年では雨と気温の関係は積極的に支持されない

       ## 月毎の気温の差を考慮して月を表す変数をダミー化する
       TW.data <- transform(TW.data,
                            month=factor(month))
       summary(lm(temp ~ rain + month, data=TW.data))
       ## 月毎に比較すると雨の日の方が気温が低いことが支持される
     #+end_src

* COMMENT 補遺

* COMMENT 補遺 car package の紹介
** COMMENT さまざまな評価
   - 回帰モデルの評価
     - 与えられたデータの再現
     - 新しいデータの予測
   - モデルの再構築のための視覚化
     - *residual plots*: 
       説明変数・予測値と残差の関係
     - *marginal-model plots*:
       説明変数と目的変数・モデルの関係
     - *added-variable plots*:
       説明変数・目的変数をその他の変数で回帰したときの残差の関係
     - *component+residual plots*:
       説明変数とそれ以外の説明変数による残差の関係
     # - QQ plots
     # - spread-level plot 
     # - influence plots
     などが用意されている
** COMMENT 演習: car package の使用例
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - [[./code/06-car.r][06-car.r]] を確認してみよう

** COMMENT 演習
   :PROPERTIES:
   :reveal_background: #EEEEFF
   :END:
   - これまでに用いたデータでモデルを更新して評価してみよう
     - 変数間の線形回帰の関係について仮説を立てる 
     - モデルのあてはめを行い評価する
       - 説明力があるのか? (\(F\)-統計量，\(t\)-統計量，決定係数)
       - 残差に偏りはないか? (様々な診断プロット)
       - 変数間の線形関係は妥当か? (様々な診断プロット)
     - 検討結果を踏まえてモデルを更新する (評価の繰り返し)


* COMMENT ローカル変数
# Local Variables:
# org-latex-listings: minted
# End:
