<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>回帰分析</title>
<meta name="author" content="村田 昇"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/oer-reveal.css" id="theme"/>

<link rel="stylesheet" href="./reveal.js/plugin/toc-progress/toc-progress.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/toc-style.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/fonts/source-sans-pro/source-sans-pro.css"/>

<link rel="stylesheet" href="./reveal.js/plugin/accessibility/helper.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/mycourse.css"/>
<link rel="stylesheet" href="./reveal.js/plugin/highlight/zenburn.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide" data-state="no-toc-progress">
<!-- This is an HTML template for the title slide. -->
<!-- Embed logos as necessary. -->
<!-- <a class="nooutlink" href="url"><img class="state-background your-logo-class" src="whatever.png" alt="Whatever" /></a> -->
<div class="talk-title">
    <h1 class="no-toc-progress">回帰分析</h1>
</div>
<div class="talk-subtitle">
    <p>予測と発展的なモデル</p>
</div>
<div class="keyboard-usage">
    <p>(Press <code>?</code> for help, <code>n</code> and <code>p</code> for next and previous slide)</p>
</div>
<div class="talk-author">
  <p>村田 昇<br />
  </p>
</div>

</section>

<section>
<section id="slide-org0332042">
<h2 id="org0332042">講義概要</h2>
<ul>
<li>第1回: 回帰モデルの考え方と推定</li>
<li>第2回: モデルの評価</li>
<li><b>第3回: モデルによる予測と発展的なモデル</b></li>

</ul>
<div class="slide-footer"><br></div>

</section>
</section>
<section>
<section id="slide-orgf032095">
<h2 id="orgf032095">回帰分析の復習</h2>
<div class="outline-text-2" id="text-orgf032095">
</div>
</section>
<section id="slide-org6c46789">
<h3 id="org6c46789">線形回帰モデル</h3>
<ul>
<li><b>目的変数</b> を <b>説明変数</b> で説明する関係式を構成:
<ul>
<li>説明変数: \(x_1,\dotsc,x_p\) (p次元)</li>
<li>目的変数: \(y\) (1次元)</li>

</ul></li>
<li><p>
<b>回帰係数</b> \(\beta_0,\beta_1,\dotsc,\beta_p\) を用いた一次式:
</p>
<blockquote>
<div>
\begin{equation}
  y=\beta_0+\beta_1x_1+\dotsb+\beta_px_p
\end{equation}

</div>
</blockquote></li>
<li><p>
<b>誤差項</b> を含む確率モデルで観測データを表現:
</p>
<blockquote>
<div>
\begin{equation}
  y_i=\beta_0+\beta_1 x_{i1}+\cdots+\beta_px_{ip}+\epsilon_i
  \quad (i=1,\dotsc,n)
\end{equation}

</div>
</blockquote></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org8716fd9">
<h3 id="org8716fd9">問題設定</h3>
<ul>
<li><p>
確率モデル:
</p>
<blockquote>
<div>
\begin{equation}
  \boldsymbol{y}
  =X\boldsymbol{\beta}+\boldsymbol{\epsilon}
\end{equation}

</div>
</blockquote></li>
<li><p>
式の評価: <b>残差平方和</b> の最小化による推定
</p>
<blockquote>
<div>
\begin{equation}
  S(\boldsymbol{\beta})
  =(\boldsymbol{y}-X\boldsymbol{\beta})^{\mathsf{T}}
  (\boldsymbol{y}-X\boldsymbol{\beta})
\end{equation}

</div>
</blockquote></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-orgc37bd69">
<h3 id="orgc37bd69">解</h3>
<ul>
<li><p>
解の条件: <b>正規方程式</b>
</p>
<blockquote>
<div>
\begin{equation}
  X^{\mathsf{T}}X\boldsymbol{\beta}
  =X^{\mathsf{T}}\boldsymbol{y}
\end{equation}

</div>
</blockquote></li>
<li><p>
解の一意性: <b>Gram 行列</b> \(X^{\mathsf{T}}X\) が正則
</p>
<blockquote>
<div>
\begin{equation}
  \hat{\boldsymbol{\beta}}
  =
  (X^{\mathsf{T}}X)^{-1}
  X^{\mathsf{T}}\boldsymbol{y}  
\end{equation}

</div>
</blockquote></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org1cca09b">
<h3 id="org1cca09b">寄与率</h3>
<ul>
<li><p>
<b>決定係数</b> (R-squared):
</p>
<blockquote>
<div>
\begin{equation}
  R^2
  =
  1-\frac{\sum_{i=1}^n\hat{\epsilon}_i^2}{\sum_{i=1}^n(y_i-\bar{y})^2}
\end{equation}

</div>
</blockquote></li>
<li><p>
<b>自由度調整済み決定係数</b> (adjusted R-squared):
</p>
<blockquote>
<div>
\begin{equation}
  \bar{R}^2
  =
  1-\frac{\frac{1}{n{-}p{-}1}\sum_{i=1}^n\hat{\epsilon}_i^2}
  {\frac{1}{n{-}1}\sum_{i=1}^n(y_i-\bar{y})^2}
\end{equation}

</div>
</blockquote>
<ul>
<li>不偏分散で補正</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org98d4676">
<h3 id="org98d4676">実データによる例</h3>
<ul>
<li><p>
東京の8月の気候 (気温,降雨,日射,降雪,風速,気圧,湿度,雲量)
に関するデータ(の一部)
</p>
<pre class="example" id="orge675eda">
    month day day_of_week temp rain solar snow wdir wind  press humid cloud
214     8   1         Sat 26.1  0.5 19.79    0   NE  2.6 1009.3    77   7.8
215     8   2         Sun 26.3  0.0 19.53    0  SSE  2.4 1011.0    75   5.5
216     8   3         Mon 27.2  0.0 24.73    0  SSE  2.4 1011.0    74   3.8
217     8   4         Tue 28.3  0.0 24.49    0  SSE  2.9 1012.2    77   4.3
218     8   5         Wed 29.1  0.0 24.93    0    S  2.9 1013.4    76   3.3
219     8   6         Thu 28.5  0.0 24.02    0  SSE  3.9 1010.5    79   7.8
220     8   7         Fri 29.5  0.0 22.58    0    S  3.4 1005.0    71   7.5
221     8   8         Sat 28.1  0.0 15.49    0   SE  2.7 1006.1    79   8.3
222     8   9         Sun 28.7  0.0 19.96    0  SSE  2.4 1006.9    77   9.5
223     8  10         Mon 30.5  0.0 20.26    0   SE  2.4 1010.3    73  10.0
224     8  11         Tue 31.7  0.0 25.50    0    S  4.0 1009.7    67   2.8
225     8  12         Wed 30.0  0.5 18.24    0  SSE  2.5 1009.0    79   6.8
226     8  13         Thu 29.4 21.5 19.01    0    N  2.2 1006.4    82   5.0
227     8  14         Fri 29.4  0.0 19.85    0   SE  2.8 1005.5    78   2.0
</pre></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section>
<ul>
<li>作成した線形回帰モデルを検討する
<ul>
<li>モデル1: 気温 = F(気圧)</li>
<li>モデル2: 気温 = F(気圧, 日射)</li>
<li>モデル3: 気温 = F(気圧, 日射, 湿度)</li>
<li>モデル4: 気温 = F(気圧, 日射, 雲量)</li>

</ul></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section>
<ul>
<li><p>
説明変数と目的変数の関係
</p></li>

</ul>


<div id="orgb858724" class="figure">
<p><img src="figs/05_variables.png" alt="05_variables.png" />
</p>
<p><span class="figure-number">Figure 1: </span>説明変数と目的変数の散布図</p>
</div>

<div class="slide-footer"><br></div>
</section>
<section>
<ul>
<li><p>
観測値とあてはめ値の比較
</p></li>

</ul>


<div id="org634b562" class="figure">
<p><img src="figs/05_models.png" alt="05_models.png" />
</p>
<p><span class="figure-number">Figure 2: </span>モデルの比較</p>
</div>
<div class="slide-footer"><br></div>
</section>
<section id="slide-org3658fd2">
<h3 id="org3658fd2">モデルの評価</h3>
<ul>
<li>決定係数
<ul>
<li><p>
モデル1: 気温 = F(気圧)
</p>
<pre class="example">
[1] "R2: 0.0169 ; adj. R2: -0.017"
</pre></li>

<li><p>
モデル2: 気温 = F(気圧, 日射)
</p>
<pre class="example">
[1] "R2: 0.32 ; adj. R2: 0.271"
</pre></li>

<li><p>
モデル3: 気温 = F(気圧, 日射, 湿度) (2より改善している)
</p>
<pre class="example">
[1] "R2: 0.422 ; adj. R2: 0.358"
</pre></li>

<li><p>
モデル4: 気温 = F(気圧, 日射, 雲量) (2より改善していない)
</p>
<pre class="example">
[1] "R2: 0.32 ; adj. R2: 0.245"
</pre></li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org9928bc7">
<h3 id="org9928bc7">\(F\)-統計量による検定</h3>
<ul>
<li>説明変数のうち1つでも役に立つか否かを検定する
<ul>
<li>帰無仮説 \(H_{0}\): \(\beta_1=\dotsb=\beta_p=0\)</li>
<li>対立仮説 \(H_{1}\): \(\exists j\;\beta_j\neq0\) (少なくとも1つは役に立つ)</li>

</ul></li>
<li><p>
\(F\)-統計量: 決定係数(または残差)を用いて計算
</p>
<blockquote>
<div>
\begin{equation}
  F
  =\frac{n{-}p{-}1}{p}\frac{R^2}{1-R^2}
\end{equation}

</div>
</blockquote></li>
<li>\(p\)-値: 自由度 \(p,n{-}p{-}1\) の \(F\)-分布で計算</li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-orgeaa4be7">
<h3 id="orgeaa4be7">モデルの評価</h3>
<ul>
<li>決定係数と\(F\)-統計量
<ul>
<li><p>
モデル1: 気温 = F(気圧)
</p>
<pre class="example">
[1] "R2: 0.0169 ; adj. R2: -0.017 ; F-stat: 0.498 ; p-val: 0.486"
</pre></li>

<li><p>
モデル2: 気温 = F(気圧, 日射)
</p>
<pre class="example">
[1] "R2: 0.32 ; adj. R2: 0.271 ; F-stat: 6.58 ; p-val: 0.00454"
</pre></li>

<li><p>
モデル3: 気温 = F(気圧, 日射, 湿度)
</p>
<pre class="example">
[1] "R2: 0.422 ; adj. R2: 0.358 ; F-stat: 6.57 ; p-val: 0.00177"
</pre></li>

<li><p>
モデル4: 気温 = F(気圧, 日射, 雲量)
</p>
<pre class="example">
[1] "R2: 0.32 ; adj. R2: 0.245 ; F-stat: 4.24 ; p-val: 0.0141"
</pre></li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-orge9543f8">
<h3 id="orge9543f8">\(t\)-統計量による検定</h3>
<ul>
<li>回帰係数 \(\beta_j\) が回帰式に寄与するか否かを検定する
<ul>
<li>帰無仮説 \(H_{0}\): \(\beta_j=0\)</li>
<li>対立仮説 \(H_{1}\): \(\beta_j\neq0\) (\(\beta_j\) は役に立つ)</li>

</ul></li>
<li><p>
\(t\)-統計量: 各係数ごと，\(\zeta\) は \((X^{\mathsf{T}} X)^{-1}\) の対角成分
</p>
<blockquote>
<div>
\begin{equation}
  t=\frac{\hat{\beta}_j}{\hat{\sigma}\zeta_{j}}
\end{equation}

</div>
</blockquote></li>
<li>\(p\)-値: 自由度 \(n{-}p{-}1\) の \(t\)-分布を用いて計算</li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-orgc331a6f">
<h3 id="orgc331a6f">モデルの評価</h3>
<ul>
<li>回帰係数の推定量と\(t\)-統計量
<ul>
<li><p>
モデル1: 気温 = F(気圧)
</p>
<pre class="example">
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept) 120.0000    128.000   0.932    0.359
press        -0.0898      0.127  -0.706    0.486
</pre>


<ul>
<li>気圧単体では回帰係数は有意ではない</li>

</ul></li>
<li><p>
モデル2: 気温 = F(気圧, 日射)
</p>
<pre class="example">
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  274.000   117.0000    2.34  0.02670
press         -0.248     0.1170   -2.13  0.04240
solar          0.261     0.0738    3.53  0.00145
</pre>


<ul>
<li>日射と組み合わせることで有意となる</li>

</ul></li>

</ul></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section>
<ul>
<li>回帰係数の推定量と\(t\)-統計量 (つづき)
<ul>
<li><p>
モデル3: 気温 = F(気圧, 日射, 湿度)
</p>
<pre class="example">
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  263.000   110.0000    2.39   0.0242
press         -0.222     0.1100   -2.02   0.0537
solar          0.142     0.0880    1.61   0.1180
humid         -0.166     0.0759   -2.18   0.0379
</pre></li>

<li><p>
モデル4: 気温 = F(気圧, 日射, 雲量) 
</p>
<pre class="example">
            Estimate Std. Error t value Pr(&gt;|t|)
(Intercept)  274.000   119.0000   2.300  0.02950
press         -0.248     0.1190  -2.090  0.04610
solar          0.266     0.0915   2.910  0.00723
cloud          0.013     0.1250   0.104  0.91800
</pre>


<ul>
<li>このモデルでは雲量は有用でないことが示唆される</li>

</ul></li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
</section>
<section>
<section id="slide-orgad2b87d">
<h2 id="orgad2b87d">回帰モデルによる予測</h2>
<div class="outline-text-2" id="text-orgad2b87d">
</div>
</section>
<section id="slide-org522f661">
<h3 id="org522f661">予測</h3>
<ul>
<li><p>
新しいデータ (説明変数) \(\boldsymbol{x}\) に対する <b>予測値</b>
</p>
<blockquote>
<div>
\begin{equation}
  \hat{y}
  =
  (1,\boldsymbol{x}^{\mathsf{T}})\hat{\boldsymbol{\beta}},
  \qquad
  \hat{\boldsymbol{\beta}}
  =
  (X^{\mathsf{T}}X)^{-1}
  X^{\mathsf{T}}\boldsymbol{y}
\end{equation}

</div>
</blockquote></li>
<li><p>
予測値は元データの目的変数の重み付け線形和
</p>
<blockquote>
<div>
\begin{equation}
  \hat{y}
  =
  \boldsymbol{w}(\boldsymbol{x})^{\mathsf{T}}\boldsymbol{y}
\end{equation}

</div>
<div>
\begin{equation}
  \boldsymbol{w}(\boldsymbol{x})^{\mathsf{T}}
  =
  (1,\boldsymbol{x}^{\mathsf{T}})
  (X^{\mathsf{T}}X)^{-1}
  X^{\mathsf{T}}
\end{equation}

</div>
</blockquote>
<ul>
<li>重みは元データと新規データの説明変数で決定</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org825a582">
<h3 id="org825a582">予測値の性質</h3>
<ul>
<li><p>
推定量は以下の性質をもつ多変量正規分布
</p>
<blockquote>
<div>
\begin{align}
  \mathbb{E}[\hat{\boldsymbol{\beta}}]
  &=\boldsymbol{\beta}\\
  \mathrm{Cov}(\hat{\boldsymbol{\beta}})
  &=\sigma^{2}(X^{\mathsf{T}}X)^{-1}
\end{align}

</div>
</blockquote></li>
<li><p>
この性質を利用して以下の3つの値の違いを評価
</p>
<blockquote>
<div>
\begin{align}
  \hat{y}&=(1,\boldsymbol{x}^{\mathsf{T}})\hat{\boldsymbol{\beta}}
  &&\text{(回帰式による予測値)}\\
  \tilde{y}&=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}
  &&\text{(最適な予測値)}\\
  y&=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}+\epsilon
  &&\text{(観測値)}
\end{align}

</div>
</blockquote>
<ul>
<li>\(\hat{y}\) と \(y\) は独立な正規分布に従うことに注意</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>


</section>
</section>
<section>
<section id="slide-orgb401b88">
<h2 id="orgb401b88">信頼区間</h2>
<div class="outline-text-2" id="text-orgb401b88">
</div>
</section>
<section id="slide-orgd83261b">
<h3 id="orgd83261b">最適な予測値との差</h3>
<ul>
<li><p>
差の分布は以下の平均・分散をもつ正規分布に従う
</p>
<blockquote>
<div>
\begin{align}
  \mathbb{E}[\tilde{y}-\hat{y}]
  &=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}
    -(1,\boldsymbol{x}^{\mathsf{T}})\mathbb{E}[\hat{\boldsymbol{\beta}}]
    =0\\
  \mathrm{Var}(\tilde{y}-\hat{y})
  &=\underbrace{\sigma^{2}(1,\boldsymbol{x}^{\mathsf{T}})(X^{\mathsf{T}}X)^{-1}
    (1,\boldsymbol{x}^{\mathsf{T}})^{\mathsf{T}}}_{\text{\(\hat{\boldsymbol{\beta}}\)の推定誤差による分散}}
    =\sigma^{2}\gamma_{c}(\boldsymbol{x})^{2}
\end{align}

</div>
</blockquote></li>
<li><p>
正規化による表現
</p>
<blockquote>
<div>
\begin{equation}
  \frac{\tilde{y}-\hat{y}}{\sigma\gamma_{c}(\boldsymbol{x})}
  \sim \mathcal{N}(0,1)
\end{equation}

</div>
</blockquote></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org2314f99">
<h3 id="org2314f99">信頼区間</h3>
<ul>
<li><p>
未知の分散を不偏分散で推定
</p>
<blockquote>
<div>
\begin{equation}
  Z=
  \frac{\tilde{y}-\hat{y}}{\hat{\sigma}\gamma_{c}(\boldsymbol{x})}
  \sim \mathcal{T}(n{-}p{-}1) 
  \quad (\text{\(t\)-分布})
\end{equation}

</div>
</blockquote></li>
<li><p>
確率 \(\alpha\) の信頼区間
</p>
<blockquote>
<div>
\begin{equation}
  \mathcal{I}^{c}_{\alpha}
  =
  \left(
    \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x}),\;
    \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x})
  \right)
\end{equation}

</div>

<div>
\begin{equation}
  P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
  =\alpha
\end{equation}

</div>
</blockquote>
<ul>
<li>最適な予測値 \(\tilde{y}\) が入ることが期待される区間</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>


</section>
</section>
<section>
<section id="slide-org3726ab9">
<h2 id="org3726ab9">予測区間</h2>
<div class="outline-text-2" id="text-org3726ab9">
</div>
</section>
<section id="slide-org36f0395">
<h3 id="org36f0395">観測値との差</h3>
<ul>
<li><p>
差の分布は以下の平均・分散をもつ正規分布に従う
</p>
<blockquote>
<div>
\begin{align}
  \mathbb{E}[y-\hat{y}]
  &=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}
    +\mathbb{E}[\boldsymbol{\epsilon}]
    -(1,\boldsymbol{x}^{\mathsf{T}})
    \mathbb{E}[\hat{\boldsymbol{\beta}}]
    =0\\
  \mathrm{Var}(y-\hat{y})
  &=\underbrace{\sigma^{2}
    (1,\boldsymbol{x}^{\mathsf{T}})(X^{\mathsf{T}}X)^{-1}
    (1,\boldsymbol{x}^{\mathsf{T}})^{\mathsf{T}}
    }_{\text{\(\hat{\boldsymbol{\beta}}\)の推定誤差による分散}}
    +\underbrace{\sigma^{2}}_{\text{誤差の分散}}
    =\sigma^{2}\gamma_{p}(\boldsymbol{x})^{2}
\end{align}

</div>
</blockquote></li>
<li><p>
正規化による表現
</p>
<blockquote>
<div>
\begin{equation}
  \frac{y-\hat{y}}{\sigma\gamma_{p}(\boldsymbol{x})}
  \sim \mathcal{N}(0,1)
\end{equation}

</div>
</blockquote></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org6fa7da1">
<h3 id="org6fa7da1">予測区間</h3>
<ul>
<li><p>
未知の分散を不偏分散で推定
</p>
<blockquote>
<div>
\begin{equation}
  Z=
  \frac{y-\hat{y}}{\hat{\sigma}\gamma_{p}(\boldsymbol{x})}
  \sim \mathcal{T}(n{-}p{-}1) 
  \quad (\text{\(t\)-分布})
\end{equation}

</div>
</blockquote></li>
<li><p>
確率 \(\alpha\) の予測区間 
</p>
<blockquote>
<div>
\begin{equation}
  \mathcal{I}^{p}_{\alpha}
  =
  \left(
    \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x}),\;
    \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x})
  \right)
\end{equation}

</div>

<div>
\begin{equation}
  P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
  =\alpha
\end{equation}

</div>
</blockquote>

<ul>
<li>観測値 \(y\) が入ることが期待される区間</li>
<li>\(\gamma_{p}>\gamma_{c}\) なので信頼区間より広くなる</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>



</section>
</section>
<section>
<section id="slide-orgd7a5b91" data-background="#fef4f4">
<h2 id="orgd7a5b91">演習</h2>
<div class="slide-footer"><br></div>
</section>
<section id="slide-org1d26ad4" data-background="#fef4f4">
<h3 id="org1d26ad4">R: 予測値と区間推定</h3>
<ul>
<li><p>
関数 <code>predict()</code> を用いた予測
</p>
<div class="org-src-container">

<pre><code class="R" >## モデルの作成
train &lt;- data.frame(x1=..., x2=..., y=...)
est  &lt;- lm(y ~ x1 + x2, data=train) 
fit  &lt;- predict(est) # あてはめ値の計算
## 新しいデータの予測
test &lt;- data.frame(x1=..., x2=...) # 予測したいデータの説明変数
pred &lt;- predict(est, # 予測値の計算
		newdata=test) # 説明変数のデータフレーム
cint &lt;- predict(est, newdata=test, 
		interval="confidence", level=0.95) # 信頼区間
pint &lt;- predict(est, newdata=test, 
		interval="prediction", level=0.95) # 予測区間
## 信頼区間，予測区間の水準の既定値は0.95
</code></pre>
</div></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-orgad2da14" data-background="#fef4f4">
<h3 id="orgad2da14">R: モデルからの予測</h3>
<ul>
<li><p>
東京の気候データによる例
</p>
<div class="org-src-container">

<pre><code class="R" >### 9,10月のデータでモデルを構築し，8,11月のデータを予測
TW.data &lt;- read.csv("data/tokyo_weather.csv")
TW.train &lt;- subset(TW.data, # モデル推定用データ
		   subset= month %in% c(9,10)) # %in% は集合に含むか
TW.test  &lt;- subset(TW.data, # 予測用データ
		   subset= month %in% c(8,11))

TW.model &lt;- temp ~ solar + press # モデルの定義 
TW.est &lt;- lm(TW.model, data=TW.train) # モデルの推定
summary(TW.est) # モデルの評価
TW.fit  &lt;- predict(TW.est) # データのあてはめ値
TW.pred &lt;- predict(TW.est, # 新規データの予測値
		   newdata=TW.test) 
</code></pre>
</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section data-background="#fef4f4">
<ul>
<li><p>
グラフ表示の例
</p>
<div class="org-src-container">

<pre><code class="R" >## 予測結果を図示
myColor &lt;- rep("black",12) 
myColor[8:11] &lt;- c("red","orange","violet","blue") # 色の定義
with(TW.train,
     plot(temp ~ TW.fit, pch=1, col=myColor[month],
	  xlab="fitted", ylab="observed"))
with(TW.test,
     points(temp ~ TW.pred, pch=4, col=myColor[month]))
abline(0,1,col="gray") # 予測が完全に正しい場合のガイド線
legend("bottomright",inset=.05, pch=15, # 凡例の作成
       legend=c("Aug","Sep","Oct","Nov"), col=myColor[8:11])
</code></pre>
</div></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org7c2dcf2" data-background="#fef4f4">
<h3 id="org7c2dcf2">練習問題</h3>
<ul>
<li><p>
東京の気候データを用いて以下の実験を試みなさい
</p>
<ul>
<li>8月のデータで回帰式を推定する</li>
<li>上記のモデルで9月のデータを予測する</li>

</ul>
<div class="org-src-container">

<pre><code class="R" >## 8月と9月のデータを取り出すには，例えば以下のようにすればよい
TW.data &lt;- read.csv("data/tokyo_weather.csv")
TW.train &lt;- subset(TW.data, subset= month==8) # 推定用データ
TW.test  &lt;- subset(TW.data, subset= month %in% 9) # 予測用データ
</code></pre>
</div></li>

</ul>
<div class="slide-footer"><br></div>

</section>
</section>
<section>
<section id="slide-org1b47109">
<h2 id="org1b47109">発展的なモデル</h2>
<div class="outline-text-2" id="text-org1b47109">
</div>
</section>
<section id="slide-orgffec250">
<h3 id="orgffec250">非線形性を含むモデル</h3>
<ul>
<li>目的変数 \(Y\)</li>
<li>説明変数 \(X_1,\dotsc,X_p\)</li>
<li>説明変数の追加で対応可能
<ul>
<li>交互作用 (交差項): \(X_iX_j\) のような説明変数の積</li>
<li>非線形変換: \(\log(X_k)\) のような関数による変換</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org8e2a673">
<h3 id="org8e2a673">カテゴリカル変数を含むモデル</h3>
<ul>
<li>数値ではないデータ
<ul>
<li><span style="color:darkgreen;">悪性良性</span></li>
<li><span style="color:darkgreen;">血液型</span></li>

</ul></li>
<li>適切な方法で数値に変換して対応:
<ul>
<li>2値の場合は 1,0 (真，偽) を割り当てる
<ul>
<li>悪性: 1</li>
<li>良性: 0</li>

</ul></li>
<li>3値以上の場合は <b>ダミー変数</b> を利用する (カテゴリ数-1個)
<ul>
<li>A型: (1,0,0)</li>
<li>B型: (0,1,0)</li>
<li>O型: (0,0,1)</li>
<li>AB型: (0,0,0)</li>

</ul></li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>


</section>
</section>
<section>
<section id="slide-orge4adf18" data-background="#fef4f4">
<h2 id="orge4adf18">演習</h2>
<div class="slide-footer"><br></div>
</section>
<section id="slide-org842aeb8" data-background="#fef4f4">
<h3 id="org842aeb8">R: 線形でないモデル式の書き方</h3>
<ul>
<li>交互作用を記述するためには特殊な記法がある</li>
<li>非線形変換はそのまま関数を記述すればよい</li>
<li><p>
1つの変数の多項式は関数 <code>I()</code> を用いる
</p>
<div class="org-src-container">

<pre><code class="R" >## 目的変数 Y, 説明変数 X1,X2,X3
## 交互作用を含む式 (formula) の書き方
Y ~ X1 + X1:X2       # X1 + X1*X2
Y ~ X1 * X2          # X1 + X2 + X1*X2
Y ~ (X1 + X2 + X3)^2 # X1 + X2 + X3 + X1*X2 + X2*X3 + X3*X1
## 非線形変換を含む式 (formula) の書き方
Y ~ f(X1)            # f(X1) (fは任意の関数)
Y ~ X1 + I(X2^2)     # X1 + X2^2
</code></pre>
</div></li>

</ul>
<div class="slide-footer"><br></div>
</section>
<section id="slide-orgde261e7" data-background="#fef4f4">
<h3 id="orgde261e7">R: カテゴリカル変数の取り扱い</h3>
<ul>
<li>何も宣言しなくても通常は適切に対応してくれる</li>
<li><p>
陽に扱う場合は関数 <code>factor()</code> を利用する
</p>
<div class="org-src-container">

<pre><code class="R" >## factor属性の与え方
X &lt;- c("A","S","A","B","D")
Y &lt;- c(85,100,80,70,30)
dat1 &lt;- data.frame(X,Y)
dat2 &lt;- transform(dat1, 
		  X2=factor(X))
str(dat2) # 作成したデータフレームの素性を見る
dat3 &lt;- transform(dat2, 
		  X3=factor(X, levels=c("S","A","B","C","D")))
str(dat3) # dat2とはfactorの順序が異なる
dat4 &lt;- transform(dat2,
		  Y2=factor(Y &gt; 60)) 
str(dat4) # 条件の真偽で2値に類別される
</code></pre>
</div></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-org9ecb5b1" data-background="#fef4f4">
<h3 id="org9ecb5b1">練習問題</h3>
<ul>
<li>東京の気候データ(9-11月)を用いて
気温を回帰する以下のモデルを検討しなさい
<ul>
<li>日射量，気圧，湿度の線形回帰モデル</li>
<li>湿度の対数を考えた線形回帰モデル</li>
<li>最初のモデルにそれぞれの交互作用を加えたモデル</li>

</ul></li>
<li>東京の気候データ(1年分)を用いて
気温を回帰する以下のモデルを検討しなさい
<ul>
<li>降水の有無を表すカテゴリカル変数を用いたモデル <br />
(雨が降ると気温が変化することを検証する)</li>
<li>上記に月をカテゴリカル変数として加えたモデル <br />
(月毎の気温の差を考慮する)</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
</section>
<section>
<section id="slide-orgc41f44c">
<h2 id="orgc41f44c">補足</h2>
<div class="slide-footer"><br></div>
</section>
<section id="slide-orgf288db9">
<h3 id="orgf288db9">R: モデルの探索</h3>
<ul>
<li>変数が増えるとモデルの比較が困難</li>
<li><p>
関数 <code>step()</code> を用いて自動化することができる
</p>
<div class="org-src-container">

<pre><code class="R" >## モデルの探索
Adv.data &lt;- read.csv('https://www.statlearning.com/s/Advertising.csv',
		     row.names=1) 
summary(lm(sales ~ radio, data=Adv.data))
summary(lm(sales ~ TV + radio, data=Adv.data))
summary(lm(sales ~ TV + radio + newspaper, data=Adv.data))
summary(init &lt;- lm(sales ~ TV * radio * newspaper, data=Adv.data))
opt &lt;- step(init)
summary(opt)
</code></pre>
</div>
<ul>
<li>最適とは限らないので注意は必要</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-orgdd946d8">
<h3 id="orgdd946d8">R: car package</h3>
<ul>
<li>回帰モデルの評価
<ul>
<li>与えられたデータの再現</li>
<li>新しいデータの予測</li>

</ul></li>
<li><p>
モデルの再構築のための視覚化
</p>
<ul>
<li><b>residual plots</b>: 
説明変数・予測値と残差の関係</li>
<li><b>marginal-model plots</b>:
説明変数と目的変数・モデルの関係</li>
<li><b>added-variable plots</b>:
説明変数・目的変数をその他の変数で回帰したときの残差の関係</li>
<li><b>component+residual plots</b>:
説明変数とそれ以外の説明変数による残差の関係</li>

</ul>

<p>
などが用意されている
</p></li>

</ul>
<div class="slide-footer"><br></div>

</section>
<section id="slide-orgd4e0fcb">
<h3 id="orgd4e0fcb">例題</h3>
<ul>
<li>これまでに用いたデータでモデルを更新して評価してみよう
<ul>
<li>変数間の線形回帰の関係について仮説を立てる</li>
<li>モデルのあてはめを行い評価する
<ul>
<li>説明力があるのか? (\(F\)-統計量，\(t\)-統計量，決定係数)</li>
<li>残差に偏りはないか? (様々な診断プロット)</li>
<li>変数間の線形関係は妥当か? (様々な診断プロット)</li>

</ul></li>
<li>検討結果を踏まえてモデルを更新する (評価の繰り返し)</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>

</section>
</section>
<section>
<section id="slide-org9a0fbfb">
<h2 id="org9a0fbfb">次週の予定</h2>
<ul>
<li><b>第1回: 主成分分析の考え方</b></li>
<li>第2回: 分析の評価と視覚化</li>

</ul>
<div class="slide-footer"><br></div>
</section>
</section>
</div>
</div>
<script src="./reveal.js/dist/reveal.js"></script>
<script src="./reveal.js/plugin/notes/notes.js"></script>
<script src="./reveal.js/plugin/search/search.js"></script>
<script src="./reveal.js/plugin/zoom/zoom.js"></script>
<script src="./reveal.js/plugin/highlight/highlight.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: true,
hashOneBasedIndex: false,
pdfSeparateFragments: false,
overview: true,

transition: 'fade',
transitionSpeed: 'default',
spotlight: { size: 90, initialPresentationMode: false }, chalkboard: { toggleChalkboardButton: { left: '80px' }, toggleNotesButton: { left: '130px'}}, keyboard: { 69: function() { RevealChalkboard.toggleNotesCanvas() }, 87: function() { RevealChalkboard.toggleChalkboard() }, 67: function() { RevealChalkboard.clear() }, 82: function() { RevealChalkboard.reset() }, 68: function() { RevealChalkboard.download() }, 88: function() { RevealChalkboard.colorNext() }, 89: function() { RevealChalkboard.colorPrev() }, 84: function() { RevealSpotlight.toggleSpotlight() }, 81: function() { RevealSpotlight.togglePresentationMode()}},

// Plugins with reveal.js 4.x
plugins: [ RevealNotes, RevealSearch, RevealZoom, RevealHighlight ],

// Optional libraries used to extend reveal.js
dependencies: [
{ src: './reveal.js/plugin/menu/menu.js'},
{ src: './reveal.js/plugin/chalkboard/chalkboard.js'},
{ src: './reveal.js/plugin/spotlight/spotlight.js'}]

});
</script>
</body>
</html>
