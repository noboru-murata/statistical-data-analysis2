---
title: "第3講 練習問題"
subtitle: "統計データ解析"
date: "`r Sys.Date()`"
format:
    html: 
      toc: true
      html-math-method: katex
      self-contained: true
      grid: 
        margin-width: 350px
execute: 
  echo: true
  warning: false
reference-location: margin
citation-location: margin
tbl-cap-location: margin
fig-cap-location: margin
editor: visual
---

## 準備

以下で利用する共通パッケージを読み込む．[^1]

[^1]: 必要なパッケージは適宜追加して良い．

```{r}
library(conflicted) # 関数名の衝突を警告
conflicts_prefer(   # 優先的に使う関数を指定
  dplyr::filter(),
  dplyr::select(),
  dplyr::lag(),
  )
library(tidyverse)  
library(broom)      # 解析結果を tibble 形式に集約
library(gt)         # 表の作成
```

## 回帰係数の推定

::: callout-note
### 回帰係数の推定

回帰係数は関数 `stats::lm()` を用いて推定することができる．

```{r}
#| eval: false
lm(formula, data, subset, weights, na.action,
   method = "qr", model = TRUE, x = FALSE, y = FALSE, qr = TRUE,
   singular.ok = TRUE, contrasts = NULL, offset, ...)
#' formula: 目的変数名 ~ 説明変数名(複数ある場合は + で並べる)
#' data: 目的変数，説明変数を含むデータフレーム
#' subset: 推定に用いるデータフレームの部分集合を指定(指定しなければ全て)
#' na.action: 欠損の扱いを指定(既定値はoption("na.action")で設定された処理)
#' model,x,y,qr: 返値にmodel.frame,model.matrix,目的変数,QR分解を含むか指定
```
:::

::: callout-tip
### 実行例

配布データ `wine.csv` を用いた ボルドーワインの価格と気候の関係に関する回帰分析は以下で実行できる．

```{r}
bw_data <- read_csv(file="data/wine.csv")  # データの読み込み
bw_fit <- lm(formula = LPRICE2 ~ . - VINT, # VINTを除く全て
             data = bw_data) 
bw_fit # 推定結果の簡単な表示
```
:::

### 問題 (広告費と売上データ)

データセット <https://www.statlearning.com/s/Advertising.csv> は 広告費(TV,radio,newspapers)と売上の関係を調べたもの [^2] である． このデータセットを用いて以下の回帰式を推定しなさい．

[^2]: Datasets in this presentation are taken from "An Introduction to Statistical Learning, with applications in R" (Springer, 2013) with permission from the authors: G. James, D. Witten, T. Hastie and R. Tibshirani. [参考](https://www.statlearning.com)

``` r
formula = sales ~ TV 
formula = sales ~ radio
formula = sales ~ TV + radio
```

```{r}

```

### 問題 (東京の気候データ)

配布したデータセット `tokyo_weather.csv` は 気象庁より取得した東京の気候データを回帰分析用に整理したもの [^3] である． このデータセットのうち，9月の気候データを用いて，以下の回帰式を推定しなさい．

[^3]: [参考](https://www.data.jma.go.jp/gmd/risk/obsdl/index.php)

```{r}
formula = temp ~ solar + press
```

```{r}

```

## 最小二乗推定量の性質

::: callout-note
### 情報の取得

関数 `stats::lm()` の出力には様々な情報が含まれる．

```{r}
#| eval: false
base::summary(lmの出力)       # 推定結果のまとめ
stats::coef(lmの出力)         # 推定された回帰係数
stats::fitted(lmの出力)       # あてはめ値
stats::resid(lmの出力)        # 残差
stats::model.frame(lmの出力)  # modelに必要な変数の抽出 (データフレーム)
stats::model.matrix(lmの出力) # デザイン行列
```

関数 `base::summary()` の tidyverse 版として `package::broom` が用意されている． 関数 `stats::lm()` の結果を tibble 形式で表示することができる．

```{r}
#| eval: false
broom::tidy(lmの出力)    # 推定結果のまとめ．coef(summary(lmの出力)) と同様
broom::glance(lmの出力)  # 評価指標(統計量)のまとめ．決定係数やF値などを整理
broom::augment(lmの出力) # 入出力データのまとめ．あてはめ値・残差などを整理
```
:::

::: callout-note
### ベクトルと行列の計算

データフレーム以外の重要なデータ構造として以下の2つがある．

-   ベクトル (vector) : 1次元の配列
-   行列 (matrix) : 2次元の同じデータ型の配列

データフレーム(の一部)は 必要であればベクトルと行列に明示的に変換できる．

```{r}
#| eval: false
as.vector(データフレーム[列名]) # base::as.vector()
as_vector(データフレーム[列名]) # purrr::as_vector()
as.matrix(データフレーム) # base::as.matrix()
#' データフレームを行列に変換する場合は全て同じデータ型でなくてはならない
```

代表的な行列とベクトルの計算は以下のようにする．

-   行列 $A,B$ の積 $AB$ および ベクトル $a,b$ の内積 $a\cdot b$

    ```{r}
    #| eval: false
    A %*% B # 行列の大きさは適切である必要がある
    a %*% b # ベクトルは同じ長さである必要がある
    ```

-   正方行列 $A$ の逆行列 $A^{-1}$

    ```{r}
    #| eval: false
    solve(A) # 他にもいくつか関数はある
    ```

-   $X^{\mathsf{T}}Y$ および $X^{\mathsf{T}}X$ の計算

    ```{r}
    #| eval: false
    crossprod(X, Y) # cross product の略
    #' X: 行列 (またはベクトル)
    #' Y: 行列 (またはベクトル)
    crossprod(X) # 同じものを掛ける場合は引数は1つで良い
    ```

    行列の転置を計算する関数 `t()`と積を組み合わせてもよい．

    ```{r}
    #| eval: false
    crossprod(X,Y) = t(X) %*% Y
    #' XY^T = (X^TY)^T を計算する関数 tcrossprod() もある
    tcrossprod(X,Y) = X %*% t(Y)
    ```
:::

### 問題

前問の推定結果を用いて，最小二乗推定量の以下の性質を確認しなさい．

-   推定された係数が正規方程式の解となること． $$
      \begin{equation}
        \boldsymbol{\hat{\beta}}
        =
        (X^{\mathsf{T}}X)^{-1}X^{\mathsf{T}}\boldsymbol{y}
      \end{equation}
    $$
-   あてはめ値と残差が直交すること．
-   回帰式が標本平均を通ること．

```{r}

```

## 残差の分解

### 問題

前問の結果を用いて，残差の性質として以下の分解が成り立つことを確認しなさい．

$$
\begin{equation}
  (\boldsymbol{y}-\bar{\boldsymbol{y}})^{\mathsf{T}}
  (\boldsymbol{y}-\bar{\boldsymbol{y}})
  =
  (\boldsymbol{y}-\boldsymbol{\hat{y}})^{\mathsf{T}}
  (\boldsymbol{y}-\boldsymbol{\hat{y}})+ 
  (\boldsymbol{\hat{y}}-\bar{\boldsymbol{y}})^{\mathsf{T}}
  (\boldsymbol{\hat{y}}-\bar{\boldsymbol{y}})
\end{equation}
$$

$$
\begin{equation}
  S_y=S+S_r
\end{equation}
$$

```{r}

```

## 決定係数によるモデルの比較

### 問題

決定係数を用いてモデルの比較を行いなさい．

-   広告費と売上データ

    ``` r
    sales ~ TV
    sales ~ radio
    sales ~ TV + radio
    ```

-   東京の9月の気候データ

    ``` r
    temp ~ solar
    temp ~ solar + press
    temp ~ solar + press + cloud
    ```

```{r}

```
