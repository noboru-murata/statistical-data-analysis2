<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>判別分析</title>
<meta name="author" content="村田 昇"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/oer-reveal.css" id="theme"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/fonts/source-sans-pro/source-sans-pro.css"/>

<link rel="stylesheet" href="./reveal.js/plugin/menu/menu.css"/>

<link rel="stylesheet" href="./reveal.js/plugin/drawer/drawer.css"/>

<link rel="stylesheet" href="./reveal.js/local/mycourse.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<!-- This is an HTML template for the title slide. -->
<!-- Embed logos as necessary. -->
<!-- <a class="nooutlink" href="url"><img class="state-background your-logo-class" src="whatever.png" alt="Whatever" /></a> -->
<div class="talk-title">
    <h1 class="no-toc-progress">判別分析</h1>
</div>
<div class="talk-subtitle">
    <p>分析の評価</p>
</div>
<div class="keyboard-usage">
    <p>(Press <code>?</code> for help, <code>n</code> and <code>p</code> for next and previous slide)</p>
</div>
<div class="talk-author">
  <p>村田 昇<br />
  </p>
</div>

</section>
<section>
<section id="slide-orgcc36a9e">
<h2 id="orgcc36a9e">講義概要</h2>
<ul>
<li>第1回 : 判別分析の考え方</li>
<li><b>第2回 : 分析の評価</b></li>

</ul>
</section>
</section>
<section>
<section id="slide-orga0532f3">
<h2 id="orga0532f3">判別分析の復習</h2>
<div class="outline-text-2" id="text-orga0532f3">
</div>
</section>
<section id="slide-org73691e8">
<h3 id="org73691e8">判別分析</h3>
<ul>
<li>個体の特徴量から
その個体の属するクラスを予測する関係式を構成</li>
<li><b>事前確率</b> : \(\pi_k=P(Y=k)\) (prior probability)
<ul>
<li>\(X=\boldsymbol{x}\) が与えられる前に予測されるクラス</li>

</ul></li>
<li><b>事後確率</b> : \(p_k(\boldsymbol{x})\) (posterior probability)
<ul>
<li><p>
\(X=\boldsymbol{x}\) が与えられた後に予測されるクラス
</p>
<blockquote>
<div>
\begin{equation}
  p_k(\boldsymbol{x})=P(Y=k|X=\boldsymbol{x})
\end{equation}

</div>
</blockquote></li>
<li>所属する確率が最も高いクラスに個体を分類</li>

</ul></li>

</ul>
</section>
<section id="slide-org4ce75d4">
<h3 id="org4ce75d4">判別関数</h3>
<ul>
<li>判別の手続き
<ul>
<li>説明変数 \(X=\boldsymbol{x}\) の取得</li>
<li>事後確率 \(p_k(\boldsymbol{x})\) の計算</li>
<li>事後確率最大のクラスにデータを分類</li>

</ul></li>
<li><p>
<b>判別関数</b> : \(\delta_k(\boldsymbol{x})\) (\(k=1,\dots,K\))
</p>
<blockquote>
<div>
\begin{equation}
  p_k(\boldsymbol{x}) 
  < 
  p_l(\boldsymbol{x})
  \Leftrightarrow
  \delta_k(\boldsymbol{x})
  <
  \delta_l(\boldsymbol{x})
\end{equation}

</div>
</blockquote>
<p>
事後確率の順序を保存する計算しやすい関数
</p></li>
<li>判別関数 \(\delta_k(\boldsymbol{x})\) を最大化するようなクラス \(k\) に分類</li>

</ul>
</section>
<section id="slide-org227c9bc">
<h3 id="org227c9bc">線形判別</h3>
<ul>
<li>\(f_k(\boldsymbol{x})\) の仮定
<ul>
<li>\(q\) 変量正規分布の密度関数</li>
<li>平均ベクトル \(\boldsymbol{\mu}_k\) : クラスごとに異なる</li>
<li><p>
共分散行列 \(\Sigma\) : <b>すべてのクラスで共通</b>
</p>
<blockquote>
<div>
\begin{equation}
  f_k(\boldsymbol{x})
  =
  \frac{1}{(2\pi)^{q/2}\sqrt{\det\Sigma}}
  \exp\left(-\frac{1}{2}(\boldsymbol{x}-\boldsymbol{\mu}_k)^{\mathsf{T}}
    \Sigma^{-1}(\boldsymbol{x}-\boldsymbol{\mu}_k)\right)
\end{equation}

</div>
</blockquote></li>

</ul></li>
<li><p>
線形判別関数 : \(\boldsymbol{x}\) の1次式
</p>

<blockquote>
<div>
\begin{equation}
  \delta_k(\boldsymbol{x})
  =
  \boldsymbol{x}^{\mathsf{T}}\Sigma^{-1}\boldsymbol{\mu}_k
  -\frac{1}{2}\boldsymbol{\mu}_k^{\mathsf{T}}\Sigma^{-1}\boldsymbol{\mu}_k
  +\log\pi_k
\end{equation}

</div>
</blockquote></li>

</ul>
</section>
<section id="slide-org0c0ab1e">
<h3 id="org0c0ab1e">2次判別</h3>
<ul>
<li>\(f_k(\boldsymbol{x})\) の仮定
<ul>
<li>\(q\) 変量正規分布の密度関数</li>
<li>平均ベクトル \(\boldsymbol{\mu}_k\) : クラスごとに異なる</li>
<li><p>
共分散行列 \(\Sigma_k\) : <b>クラスごとに異なる</b>
</p>
<blockquote>
<div>
\begin{equation}
  f_k(\boldsymbol{x})
  =
  \frac{1}{(2\pi)^{q/2}\sqrt{\det\Sigma_k}}
  \exp\left(-\frac{1}{2}(\boldsymbol{x}-\boldsymbol{\mu}_k)^{\mathsf{T}}
    \Sigma_k^{-1}(\boldsymbol{x}-\boldsymbol{\mu}_k)\right)
\end{equation}

</div>
</blockquote></li>

</ul></li>
<li><p>
2次判別関数 : \(\boldsymbol{x}\) の2次式
</p>
<blockquote>
<div>
\begin{equation}
  \delta_k(\boldsymbol{x})
  =
  -\frac{1}{2}\det\Sigma_k
  -\frac{1}{2}(\boldsymbol{x}-\boldsymbol{\mu}_k)^{\mathsf{T}}
  \Sigma_k^{-1}(\boldsymbol{x}-\boldsymbol{\mu}_k)
  +\log\pi_k
\end{equation}

</div>
</blockquote></li>

</ul>
</section>
<section id="slide-org3c8b7d5">
<h3 id="org3c8b7d5">Fisherの線形判別</h3>
<ul>
<li>新しい特徴量 \(Z=\boldsymbol{\alpha}^{\mathsf{T}} X\) を考える</li>
<li>良い \(Z\) の基準
<ul>
<li>クラス内では集まっているほど良い (\(\boldsymbol{\alpha}^{\mathsf{T}} W\boldsymbol{\alpha}\)は小)</li>
<li>クラス間では離れているほど良い (\(\boldsymbol{\alpha}^{\mathsf{T}} B\boldsymbol{\alpha}\)は大)</li>

</ul></li>
<li><p>
Fisherの基準
</p>
<blockquote>
<div>
\begin{equation}
  \text{maximize}\quad \boldsymbol{\alpha}^{\mathsf{T}} B\boldsymbol{\alpha}
  \quad\text{s.t.}\quad \boldsymbol{\alpha}^{\mathsf{T}} W\boldsymbol{\alpha}=\text{const.}
\end{equation}

</div>
</blockquote>
<ul>
<li>\(\boldsymbol{\alpha}\) は \(W^{-1}B\) の第1から第 \(K-1\) 固有ベクトル</li>
<li>判別方法: 特徴量の距離を用いる</li>
<li>\(d_{k}=\sum_{l=1}^{K-1}(\alpha_l^{\mathsf{T}}\boldsymbol{x}-\alpha_l^{\mathsf{T}}\mu_k)^2\) 
が最小のとなるクラス \(k\) に判別</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgc9789fc">
<h2 id="orgc9789fc">2値判別分析の評価</h2>
<div class="outline-text-2" id="text-orgc9789fc">
</div>
</section>
<section id="slide-orgabe40fe">
<h3 id="orgabe40fe">誤り率</h3>
<ul>
<li><p>
単純な誤り
</p>
<blockquote>
<div>
\begin{equation}
  \text{(誤り率)}
  =\frac{\text{(誤って判別されたデータ数)}}
  {\text{(全データ数)}}
\end{equation}

</div>
</blockquote></li>
<li>判別したいラベル : 陽性 (positive)
<ul>
<li><b>真陽性</b> : 正しく陽性と判定 (true positive; TP)</li>
<li><b>偽陽性</b> : 誤って陽性と判定 (false positive; FP) (<b>第I種過誤</b>)</li>
<li><b>偽陰性</b> : 誤って陰性と判定 (false negative; FN) (<b>第II種過誤</b>)</li>
<li><b>真陰性</b> : 正しく陰性と判定 (true negative; TN)</li>

</ul></li>

</ul>
</section>
<section id="slide-orga121e90">
<h3 id="orga121e90">混同行列</h3>
<font size=6>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">真値は陽性</th>
<th scope="col" class="org-left">真値は陰性</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">判別は陽性</td>
<td class="org-left">真陽性 (True Positive)</td>
<td class="org-left">偽陽性 (False Positive)</td>
</tr>

<tr>
<td class="org-left">判別は陰性</td>
<td class="org-left">偽陰性 (False Negative)</td>
<td class="org-left">真陰性 (True Negative)</td>
</tr>
</tbody>
</table>
</font>
<ul>
<li><b>confusion matrix</b></li>
<li>各条件にあてはまるデータ数を記載</li>
<li>転置で書く流儀もあるので注意 (次頁)</li>

</ul>
</section>
<section id="slide-orgf68abc0">
<h3 id="orgf68abc0">混同行列 (転置したもの)</h3>
<font size=6>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">&#xa0;</th>
<th scope="col" class="org-left">判別は陽性</th>
<th scope="col" class="org-left">判別は陰性</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">真値は陽性</td>
<td class="org-left">真陽性 (True Positive)</td>
<td class="org-left">偽陰性 (False Negative)</td>
</tr>

<tr>
<td class="org-left">真値は陰性</td>
<td class="org-left">偽陽性 (False Positive)</td>
<td class="org-left">真陰性 (True Negative)</td>
</tr>
</tbody>
</table>
</font>
<ul>
<li>パターン認識や機械学習で多く見られた書き方</li>
<li>誤差行列 (error matrix) とも呼ばれる</li>

</ul>
</section>
<section id="slide-org8f5cb6a">
<h3 id="org8f5cb6a">基本的な評価基準</h3>
<ul>
<li><p>
定義
</p>
<blockquote>
<div>
\begin{align}
  \text{(真陽性率)}
  &=\frac{TP}{TP+FN} \qquad\text{(true positive rate)}\\
  \text{(真陰性率)}
  &=\frac{TN}{FP+TN} \qquad\text{(true negative rate)}\\
  \text{(適合率)}
  &=\frac{TP}{TP+FP} \qquad\text{(precision)}\\
  \text{(正答率)}
  &=\frac{TP+TN}{TP+FP+TN+FN} \qquad\text{(accuracy)}
\end{align}

</div>
</blockquote></li>

</ul>

</section>
<section>
<ul>
<li>別名 (分野で異なるので注意)
<ul>
<li><p>
感度 (sensitivity) あるいは 再現率 (recall)
</p>
<blockquote>
<div>
\begin{equation}
  \text{(真陽性率)}
  =\frac{TP}{TP+FN}
\end{equation}

</div>
</blockquote></li>
<li><p>
特異度 (specificity)
</p>
<blockquote>
<div>
\begin{equation}
  \text{(真陰性率)}
  =\frac{TN}{FP+TN}
\end{equation}

</div>
</blockquote></li>
<li><p>
精度 (accuracy)
</p>
<blockquote>
<div>
\begin{equation}
  \text{(正答率)}
  =\frac{TP+TN}{TP+FP+TN+FN}
\end{equation}

</div>
</blockquote></li>

</ul></li>

</ul>
</section>
<section id="slide-org1cd3cd7">
<h3 id="org1cd3cd7">F-値</h3>
<ul>
<li><p>
定義 (<b>F-measure, F-score</b>)
</p>
<blockquote>
<div>
\begin{align}
  F_{1}&=\frac{2}{{1}/{\text{(再現率)}}+{1}/{\text{(適合率)}}}\\
  F_{\beta}&=\frac{\beta^{2}+1}{{\beta^{2}}/{\text{(再現率)}}+{1}/{\text{(適合率)}}}
\end{align}

</div>
</blockquote>
<ul>
<li><p>
再現率(真陽性率)と適合率の(重み付き)調和平均
</p>
<blockquote>
<div>
\begin{equation}
  \text{調和平均}
  <
  \text{相乗平均}
  <
  \text{相加平均}
\end{equation}

</div>
</blockquote></li>

</ul></li>

</ul>
</section>
<section id="slide-org1ed1469">
<h3 id="org1ed1469">Cohen の kappa 値</h3>
<ul>
<li><p>
定義 (Cohen&rsquo;s <b>kappa measure</b>)
</p>
<blockquote>
<div>
\begin{align}
  p_{o}
  &=\frac{TP+TN}{TP+FP+TN+FN} \qquad\text{(accuracy)}\\
  p_{e}
  &=\frac{TP+FP}{TP+FP+TN+FN}\cdot\frac{TP+FN}{TP+FP+TN+FN}\\
  &\quad
    +\frac{FN+TN}{TP+FP+TN+FN}\cdot\frac{FP+TN}{TP+FP+TN+FN}\\
  \kappa
  &=
    \frac{p_{o}-p_{e}}{1-p_{e}}
    =
    1-\frac{1-p_{o}}{1-p_{e}}
\end{align}

</div>
</blockquote>
<ul>
<li>観測された精度と偶然の精度の比較</li>

</ul></li>

</ul>
</section>
<section id="slide-org3b081f3">
<h3 id="org3b081f3">受信者動作特性曲線</h3>
<ul>
<li><b>ROC曲線</b> (receiver operating characteristic curve)</li>
<li><p>
2値判別関数\(\delta\)を用いた判定方法の一般形 <br />
(\(c\)は事前確率に依存する項とも考えられる)
</p>
<blockquote>
<div>
\begin{equation}
  H(\boldsymbol{x};c) =
  \begin{cases}
    \text{陽性},&\delta(\boldsymbol{x})>c\\
    \text{陰性},&\text{それ以外}
  \end{cases}
\end{equation}

</div>
</blockquote></li>
<li><p>
真陽性率と偽陽性率
</p>
<blockquote>
<div>
\begin{align}
  \mathrm{TPR}(c)
  &=P(\text{陽性を正しく陽性と判別})\\
  \mathrm{FPR}(c)&=P(\text{陰性を誤って陽性と判別})\\
  &=1-P(\text{陰性を正しく陰性と判別})\\
\end{align}

</div>
</blockquote></li>

</ul>

</section>
<section>
<ul>
<li><b>ROC曲線</b> : \(H(x;c)\)の\(c\)を自由に動かし\(x\)軸に偽陽性率，\(y\)軸に真陽性率を描画したもの
<ul>
<li>一般にROC曲線は\((0,0)\)と\((1,1)\)を結ぶ右肩上りの曲線</li>
<li>理想的な判別関数は\((0,1)\)(完全な判別)を通る</li>
<li>曲線と\(x\)軸で囲まれた面積が広い \(\Leftrightarrow\) 良い判別方法</li>

</ul></li>

</ul>

<ul>
<li><b>AUC</b> : 上記の面積 (area under the ROC curve)
<ul>
<li>ROC曲線を数量化する方法の一つ</li>
<li>判別関数の良さ(2値判別の難しさ)を測る基準の一つ</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org247fb08" data-background="#fef4f4">
<h2 id="org247fb08">実習</h2>
</section>
<section id="slide-org377d78b">
<h3 id="org377d78b">データセットの準備</h3>
<ul>
<li>以下のデータセットを使用
<ul>
<li><p>
<code>winequality-red.csv</code>
</p>
<blockquote>
<p>
UC Irvine Machine Learning Repository で公開されている
Wine Quality Data Set の一部
</p>
</blockquote>
<p>
<a href="https://archive.ics.uci.edu/ml/datasets/Wine+Quality">https://archive.ics.uci.edu/ml/datasets/Wine+Quality</a>
</p></li>
<li><p>
以下に download せずに読み込む方法を紹介する
</p>
<div class="org-src-container">

<pre class="src src-R">wq_data <span style="color: #60aa00;">&lt;-</span>
  read_delim(<span style="color: #d08928;">"https://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv"</span>,
             delim = <span style="color: #d08928;">";"</span>) |&gt; <span style="color: #808080; font-style: italic;"># </span><span style="color: #808080; font-style: italic;">&#21306;&#20999;&#12426;&#25991;&#23383;&#12364;';'</span>
  mutate(grade = factor(case_when( <span style="color: #808080; font-style: italic;"># </span><span style="color: #808080; font-style: italic;">quality &#12434; A,B,C,D &#12395;&#21106;&#12426;&#24403;&#12390;&#12427;</span>
           quality &gt;= 7 ~ <span style="color: #d08928;">"A"</span>,
           quality &gt;= 6 ~ <span style="color: #d08928;">"B"</span>,
           quality &gt;= 5 ~ <span style="color: #d08928;">"C"</span>,
           .default = <span style="color: #d08928;">"D"</span>)))
</pre>
</div></li>

</ul></li>

</ul>
</section>
<section id="slide-org6c11473">
<h3 id="org6c11473">R : 判別結果の評価</h3>
<ul>
<li>評価のための枠組
<ul>
<li><b>caret</b> : Max Kuhn @Rstudio によるパッケージ
<ul>
<li><a href="https://topepo.github.io/caret/">https://topepo.github.io/caret/</a></li>

</ul></li>
<li><b>tidymodels</b> : Max Kuhn, Hadley Wickham @RStudio による <code>tidyverse</code> 向けに再設計されたパッケージ
<ul>
<li><a href="https://www.tidymodels.org">https://www.tidymodels.org</a></li>

</ul></li>

</ul></li>
<li>本講義では tidymodels を中心に説明</li>
<li><p>
パッケージ集の利用には以下が必要
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#26368;&#21021;&#12395;&#19968;&#24230;&#12384;&#12369;&#20197;&#19979;&#12398;&#12356;&#12378;&#12428;&#12363;&#12434;&#23455;&#34892;&#12375;&#12390;&#12362;&#12367;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;">  - Package &#12479;&#12502;&#12363;&#12425; tidymodels &#12434;&#12452;&#12531;&#12473;&#12488;&#12540;&#12523;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;">  - &#12467;&#12531;&#12477;&#12540;&#12523;&#19978;&#12391;&#27425;&#12398;&#12467;&#12510;&#12531;&#12489;&#12434;&#23455;&#34892; 'install.packages("tidymodels")'</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> tidymodels &#12497;&#12483;&#12465;&#12540;&#12472;&#12398;&#35501;&#12415;&#36796;&#12415;</span>
<span style="color: #60aa00;">library</span>(tidymodels)
</pre>
</div></li>

</ul>
</section>
<section id="slide-orga84da15">
<h3 id="orga84da15">R : 混同行列</h3>
<ul>
<li><p>
関数 <code>yardstick::conf_mat()</code>
</p>
<div class="org-src-container">

<pre class="src src-R">conf_mat(data, truth, estimate,
  dnn = c(<span style="color: #d08928;">"Prediction"</span>, <span style="color: #d08928;">"Truth"</span>), case_weights = <span style="color: #00aa80;">NULL</span>, ...)
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> data: &#30495;&#20516;&#12392;&#20104;&#28204;&#20516;&#12364;&#21547;&#12414;&#12428;&#12427;&#12487;&#12540;&#12479;&#12501;&#12524;&#12540;&#12512;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> trush: &#30495;&#20516;(&#12521;&#12505;&#12523;)&#12398;&#21015;&#21517;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> estimate: &#20104;&#28204;&#20516;(&#12521;&#12505;&#12523;)&#12398;&#21015;&#21517;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; '?yardstick::conf_mat' &#12434;&#21442;&#29031;</span>
</pre>
</div></li>
<li><p>
集計や視覚化のために補助的な関数
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> object: conf_mat &#12398;&#20986;&#21147;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#27096;&#12293;&#12394;&#35413;&#20385;&#25351;&#27161;&#12434; tibble &#24418;&#24335;&#12391;&#20986;&#21147;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; '?yardstick::summary.conf_mat' &#12434;&#21442;&#29031;</span>
summary(object,
  prevalence = <span style="color: #00aa80;">NULL</span>, beta = 1, estimator = <span style="color: #00aa80;">NULL</span>,
  event_level = yardstick_event_level(), ...)
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#28151;&#21516;&#34892;&#21015;&#12434;&#22259;&#31034;</span>
autoplot(object, type = c(<span style="color: #d08928;">"mosaic"</span>, <span style="color: #d08928;">"heatmap"</span>))
</pre>
</div></li>

</ul>
</section>
<section id="slide-orga0b88bc">
<h3 id="orga0b88bc">R : ROC曲線</h3>
<ul>
<li><p>
関数 <code>yardstick::roc_curve()</code>
</p>
<div class="org-src-container">

<pre class="src src-R">roc_curve(data, truth, ...,
  na_rm = <span style="color: #00aa80;">TRUE</span>, event_level = yardstick_event_level(),
  case_weights = <span style="color: #00aa80;">NULL</span>, options = list())
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> data: &#30495;&#20516;&#12392;&#20104;&#28204;&#20516;&#12364;&#21547;&#12414;&#12428;&#12427;&#12487;&#12540;&#12479;&#12501;&#12524;&#12540;&#12512;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> trush: &#30495;&#20516;(&#12521;&#12505;&#12523;)&#12398;&#21015;&#21517;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> ...: &#20104;&#28204;&#20516;(&#12521;&#12505;&#12523;)&#12398;&#20107;&#24460;&#30906;&#29575;&#12434;&#19982;&#12360;&#12427;&#21015;&#21517;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; '?yardstick::roc_curve' &#12434;&#21442;&#29031;</span>
</pre>
</div></li>
<li><p>
視覚化のために補助的な関数
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> object: roc_curve &#12398;&#20986;&#21147;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> ROC&#26354;&#32218;&#12434;&#22259;&#31034;</span>
autoplot(object)
</pre>
</div></li>

</ul>

</section>
<section>
<ul>
<li><p>
関数 <code>yardstick::roc_auc()</code>
</p>
<div class="org-src-container">

<pre class="src src-R">roc_auc(data, truth, ..., estimator = <span style="color: #00aa80;">NULL</span>,
        na_rm = <span style="color: #00aa80;">TRUE</span>,  event_level = yardstick_event_level(),
        case_weights = <span style="color: #00aa80;">NULL</span>, options = list())
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> data: &#30495;&#20516;&#12392;&#20104;&#28204;&#20516;&#12364;&#21547;&#12414;&#12428;&#12427;&#12487;&#12540;&#12479;&#12501;&#12524;&#12540;&#12512;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> trush: &#30495;&#20516;(&#12521;&#12505;&#12523;)&#12398;&#21015;&#21517;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> ...: &#20104;&#28204;&#20516;(&#12521;&#12505;&#12523;)&#12398;&#20107;&#24460;&#30906;&#29575;&#12434;&#19982;&#12360;&#12427;&#21015;&#21517;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; '?yardstick::roc_auc' &#12434;&#21442;&#29031;</span>
</pre>
</div></li>

</ul>
</section>
<section id="slide-org2a9b582" data-background="#fef4f4">
<h3 id="org2a9b582">練習問題</h3>
<ul>
<li>前回と同様に東京の気候データの線形判別を行い，
以下を確認しなさい
<ul>
<li><p>
9月と10月の気温と湿度のデータを抽出する
</p>
<div class="org-src-container">

<pre class="src src-R">tw_data <span style="color: #60aa00;">&lt;-</span> read_csv(<span style="color: #d08928;">"data/tokyo_weather.csv"</span>) 
tw_subset  <span style="color: #60aa00;">&lt;-</span> tw_data |&gt;
  filter(month <span style="color: #60aa00;">%in%</span> c(9,10)) |&gt;
  select(temp, humid, month) |&gt;
  mutate(month = as_factor(month)) <span style="color: #808080; font-style: italic;"># </span><span style="color: #808080; font-style: italic;">&#26376;&#12434;&#22240;&#23376;&#21270;</span>
</pre>
</div></li>
<li>全てデータを用いて線形判別関数を構成する</li>
<li>構成した判別関数の評価を行う</li>
<li>ROC曲線を描画し，AUCを求める</li>

</ul></li>

</ul>
</section>
<section id="slide-org052b84c" data-background="#fef4f4">
<h3 id="org052b84c">R : 訓練・試験データの分割</h3>
<ul>
<li><p>
関数 <code>rsample::initial_split()</code> 
</p>
<div class="org-src-container">

<pre class="src src-R">initial_split(data, prop = 3/4,
              strata = <span style="color: #00aa80;">NULL</span>, breaks = 4, pool = 0.1, ...)
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> data: &#12487;&#12540;&#12479;&#12501;&#12524;&#12540;&#12512;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> prop: &#35347;&#32244;&#12487;&#12540;&#12479;&#12398;&#27604;&#29575;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> strata: &#23652;&#21029;&#12395;&#20998;&#21106;&#12377;&#12427;&#22580;&#21512;&#12398;&#22793;&#25968;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; '?rsample::initial_split' &#12434;&#21442;&#29031;</span>
</pre>
</div></li>
<li><p>
訓練・試験データの取得のための関数
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> x : initial_split &#12398;&#20986;&#21147;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35347;&#32244;&#12487;&#12540;&#12479;&#12398;&#21462;&#24471;</span>
training(x, ...)
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35430;&#39443;&#12487;&#12540;&#12479;&#12398;&#21462;&#24471;</span>
testing(x, ...)
</pre>
</div></li>

</ul>
</section>
<section id="slide-orgfef3f5a" data-background="#fef4f4">
<h3 id="orgfef3f5a">練習問題</h3>
<ul>
<li>Wine Quality Data Set を用いて
以下を確認しなさい
<ul>
<li>8:2の比率で訓練データと試験データに分割する</li>
<li>訓練データを用いて線形・2次判別関数を構成する</li>
<li>訓練データを用いて評価を行う</li>
<li>試験データを用いて評価を行う</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgafb8c9c">
<h2 id="orgafb8c9c">予測誤差</h2>
<div class="outline-text-2" id="text-orgafb8c9c">
</div>
</section>
<section id="slide-orge4de896">
<h3 id="orge4de896">訓練誤差と予測誤差</h3>
<ul>
<li><b>訓練誤差</b> :
既知データに対する誤り (training error)</li>
<li><b>予測誤差</b> :
未知データに対する誤り (predictive error)</li>
<li>訓練誤差は予測誤差より良くなることが多い</li>
<li>既知データの判別に特化している可能性がある
<ul>
<li>過適応 (over-fitting)</li>
<li>過学習 (over-training)</li>

</ul></li>
<li>予測誤差が小さい \(\Leftrightarrow\) 良い判別方法</li>

</ul>
</section>
<section id="slide-org2a62f4b">
<h3 id="org2a62f4b">交叉検証</h3>
<ul>
<li>データを訓練データと試験データに分割して用いる
<ul>
<li><b>訓練データ</b> :
判別関数を構成する (training data)</li>
<li><b>試験データ</b> :
予測精度を評価する (test data)</li>

</ul></li>
<li>データの分割に依存して予測誤差の評価が偏る</li>
<li>偏りを避けるために複数回分割を行ない評価する</li>
<li>&ldquo;交差&rdquo;と書く場合もある</li>

</ul>
</section>
<section id="slide-org586823d">
<h3 id="org586823d">交叉検証法</h3>
<ul>
<li><b>cross-validation (CV)</b></li>
<li>\(k\)-重交叉検証法 (\(k\)-fold cross-validation; \(k\)-fold CV)
<ul>
<li>\(n\) 個のデータを \(k\) ブロックにランダムに分割</li>
<li>第 \(i\) ブロックを除いた \(k{-}1\) ブロックで判別関数を推定</li>
<li>除いておいた第 \(i\) ブロックで予測誤差を評価</li>
<li>\(i=1,\dotsc,k\) で繰り返し \(k\) 個の予測誤差で評価 (平均や分散)</li>

</ul></li>
<li>leave-one-out法 (leave-one-out CV; LOO-CV)
<ul>
<li>\(k=n\) として上記を実行</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org4dc55c2" data-background="#fef4f4">
<h2 id="org4dc55c2">実習</h2>
</section>
<section id="slide-orga60ef95">
<h3 id="orga60ef95">R : LOO交叉検証法</h3>
<ul>
<li>関数 <code>lda()</code> と <code>qda()</code> はオプションで LOO交叉検証を行うことができる</li>
<li><p>
オプションの指定方法
</p>
<div class="org-src-container">

<pre class="src src-R">toy_lda <span style="color: #60aa00;">&lt;-</span> lda(formula, toy_data, CV = <span style="color: #00aa80;">TRUE</span>)
toy_lda[[<span style="color: #d08928;">"class"</span>]] <span style="color: #808080; font-style: italic;"># </span><span style="color: #808080; font-style: italic;">LOO CV &#12395;&#12424;&#12427;&#20104;&#28204;&#32080;&#26524;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#29305;&#23450;&#12398;&#12487;&#12540;&#12479;&#12434;&#38500;&#12356;&#12390;&#21028;&#21029;&#38306;&#25968;&#12434;&#27083;&#25104;&#12375;&#65292;&#12381;&#12398;&#12487;&#12540;&#12479;&#12398;&#20104;&#28204;&#12434;&#34892;&#12387;&#12390;&#12356;&#12427;</span>
toy_qda <span style="color: #60aa00;">&lt;-</span> qda(formula, toy_data, CV = <span style="color: #00aa80;">TRUE</span>)
toy_qda[[<span style="color: #d08928;">"class"</span>]] <span style="color: #808080; font-style: italic;"># </span><span style="color: #808080; font-style: italic;">LOO CV &#12395;&#12424;&#12427;&#20104;&#28204;&#32080;&#26524;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> 2&#27425;&#21028;&#21029;&#12395;&#12388;&#12356;&#12390;&#12418;&#21516;&#27096;</span>
</pre>
</div></li>

</ul>
</section>
<section id="slide-org38e750a" data-background="#fef4f4">
<h3 id="org38e750a">練習問題</h3>
<ul>
<li>MASS::biopsy を用いて2次判別の分析を行いなさい
<ul>
<li>全てのデータを用いて訓練誤差を評価する</li>
<li>LOO交叉検証法を用いて予測誤差を評価する</li>

</ul></li>

</ul>
</section>
<section id="slide-org5c58f78">
<h3 id="org5c58f78">R : k-重交叉検証法</h3>
<ul>
<li><p>
<code>tidymodels</code> パッケージの関数群を利用
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#20132;&#21449;&#26908;&#35388;&#29992;&#12398;&#12487;&#12540;&#12479;&#20998;&#21106; </span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; 'rsample::vfold_cv' &#12434;&#21442;&#29031;</span>
vfold_cv(data, v = 10, repeats = 1,
         strata = <span style="color: #00aa80;">NULL</span>, breaks = 4, pool = 0.1, ...)
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#26368;&#12418;&#31777;&#21336;&#12394;&#20966;&#29702;&#12398;&#27969;&#12428;(&#20197;&#19979;&#12398;&#38306;&#25968;&#12398;&#32068;&#12431;&#21512;&#12431;&#12379;)</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; 'workflows::workflow'</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#12362;&#12424;&#12403; 'tune::fit_resamples' &#12434;&#21442;&#29031;</span>
workflow() |&gt; 
  add_formula(&#30446;&#30340;&#22793;&#25968; ~ &#35500;&#26126;&#22793;&#25968;) |&gt;
  add_model(&#25512;&#23450;&#12395;&#29992;&#12356;&#12427;&#12514;&#12487;&#12523;) |&gt; 
  fit_resamples(resamples = vfold_cv&#12398;&#20986;&#21147;)
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35413;&#20385;&#12398;&#21462;&#24471;</span>
<span style="color: #808080; font-weight: bold; font-style: italic;">#</span><span style="color: #808080; font-weight: bold; font-style: italic;">'</span><span style="color: #808080; font-style: italic;"> &#35443;&#32048;&#12399; 'tune::collect_metrics' &#12434;&#21442;&#29031;</span>
collect_metrics(fit_resamples&#12398;&#20986;&#21147;)
</pre>
</div></li>

</ul>
</section>
<section id="slide-org52052af" data-background="#fef4f4">
<h3 id="org52052af">練習問題</h3>
<ul>
<li>Wine Quality Data Set を用いて
線形判別と2次判別の分析を行いなさい
<ul>
<li>LOO交叉検証法を用いて予測誤差を評価する</li>
<li>k-重交叉検証法を用いて予測誤差を評価する</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org0e665e8">
<h2 id="org0e665e8">次回の予定</h2>
<ul>
<li><b>第1回 : クラスタ分析の考え方と階層的方法</b></li>
<li>第2回 : 非階層的方法と分析の評価</li>

</ul>
</div>
</div>
<script src="./reveal.js/dist/reveal.js"></script>
<script src="./reveal.js/plugin/notes/notes.js"></script>
<script src="./reveal.js/plugin/search/search.js"></script>
<script src="./reveal.js/plugin/zoom/zoom.js"></script>
<script src="./reveal.js/plugin/menu/menu.js"></script>
<script src="./reveal.js/plugin/spotlight/spotlight.js"></script>
<script src="./reveal.js/plugin/drawer/drawer.js"></script>
<script src="./reveal.js/dist/theme/hidelinks.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: false,
fragmentInURL: true,
hashOneBasedIndex: false,
pdfSeparateFragments: false,
overview: true,

transition: 'fade',
transitionSpeed: 'default',
showNotes: window.location.search.match( /print-pdf/gi ) ? 'separate-page' : false,
spotlight: { size: 80, initialPresentationMode: false, }, drawer: { toggleDrawKey: "d", toggleBoardKey: "c", pathSize: 3, }, keyboard: { 81: function() { RevealSpotlight.toggleSpotlight()}, 87: function() { RevealSpotlight.togglePresentationMode();}, },

// Plugins with reveal.js 4.x
plugins: [ RevealNotes, RevealSearch, RevealZoom, RevealMenu, RevealSpotlight, RevealDrawer ],

// Optional libraries used to extend reveal.js
dependencies: [
]

});
</script>
</body>
</html>
