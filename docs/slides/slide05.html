<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>回帰分析</title>
<meta name="author" content="村田 昇"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/oer-reveal.css" id="theme"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/fonts/source-sans-pro/source-sans-pro.css"/>

<link rel="stylesheet" href="./reveal.js/plugin/menu/menu.css"/>

<link rel="stylesheet" href="./reveal.js/plugin/drawer/drawer.css"/>

<link rel="stylesheet" href="./reveal.js/local/mycourse.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<!-- This is an HTML template for the title slide. -->
<!-- Embed logos as necessary. -->
<!-- <a class="nooutlink" href="url"><img class="state-background your-logo-class" src="whatever.png" alt="Whatever" /></a> -->
<div class="talk-title">
    <h1 class="no-toc-progress">回帰分析</h1>
</div>
<div class="talk-subtitle">
    <p>予測と発展的なモデル</p>
</div>
<div class="keyboard-usage">
    <p>(Press <code>?</code> for help, <code>n</code> and <code>p</code> for next and previous slide)</p>
</div>
<div class="talk-author">
  <p>村田 昇<br />
  </p>
</div>

</section>
<section>
<section id="slide-orgcdf2d94">
<h2 id="orgcdf2d94">講義概要</h2>
<ul>
<li>第1回: 回帰モデルの考え方と推定</li>
<li>第2回: モデルの評価</li>
<li><b>第3回: モデルによる予測と発展的なモデル</b></li>

</ul>
</section>
</section>
<section>
<section id="slide-orge549420">
<h2 id="orge549420">回帰分析の復習</h2>
<div class="outline-text-2" id="text-orge549420">
</div>
</section>
<section id="slide-org2d66a7f">
<h3 id="org2d66a7f">線形回帰モデル</h3>
<ul>
<li><b>目的変数</b> を <b>説明変数</b> で説明する関係式を構成
<ul>
<li>説明変数: \(x_1,\dotsc,x_p\) (p次元)</li>
<li>目的変数: \(y\) (1次元)</li>

</ul></li>
<li><p>
<b>回帰係数</b> \(\beta_0,\beta_1,\dotsc,\beta_p\) を用いた一次式
</p>
<blockquote>
<div>
\begin{equation}
  y=\beta_0+\beta_1x_1+\dotsb+\beta_px_p
\end{equation}

</div>
</blockquote></li>
<li><p>
<b>誤差項</b> を含む確率モデルで観測データを表現
</p>
<blockquote>
<div>
\begin{equation}
  y_i=\beta_0+\beta_1 x_{i1}+\cdots+\beta_px_{ip}+\epsilon_i
  \quad (i=1,\dotsc,n)
\end{equation}

</div>
</blockquote></li>

</ul>
</section>
<section id="slide-org10252b2">
<h3 id="org10252b2">問題設定</h3>
<ul>
<li><p>
確率モデル
</p>
<blockquote>
<div>
\begin{equation}
  \boldsymbol{y}
  =X\boldsymbol{\beta}+\boldsymbol{\epsilon},
  \quad\boldsymbol{\epsilon}\sim\text{確率分布}
\end{equation}

</div>
</blockquote></li>
<li><p>
式の評価 : <b>残差平方和</b> の最小化による推定
</p>
<blockquote>
<div>
\begin{equation}
  S(\boldsymbol{\beta})
  =(\boldsymbol{y}-X\boldsymbol{\beta})^{\mathsf{T}}
  (\boldsymbol{y}-X\boldsymbol{\beta})
\end{equation}

</div>
</blockquote></li>

</ul>
</section>
<section id="slide-org12c4c8d">
<h3 id="org12c4c8d">解とその一意性</h3>
<ul>
<li><p>
解の条件 : <b>正規方程式</b>
</p>
<blockquote>
<div>
\begin{equation}
  X^{\mathsf{T}}X\boldsymbol{\beta}
  =X^{\mathsf{T}}\boldsymbol{y}
\end{equation}

</div>
</blockquote></li>
<li><p>
解の一意性 : <b>Gram 行列</b> \(X^{\mathsf{T}}X\) が正則
</p>
<blockquote>
<div>
\begin{equation}
  \hat{\boldsymbol{\beta}}
  =
  (X^{\mathsf{T}}X)^{-1}
  X^{\mathsf{T}}\boldsymbol{y}  
\end{equation}

</div>
</blockquote></li>

</ul>
</section>
</section>
<section>
<section id="slide-org3c77631">
<h2 id="org3c77631">解析の事例</h2>
<div class="outline-text-2" id="text-org3c77631">
</div>
</section>
<section id="slide-org268cd3a">
<h3 id="org268cd3a">東京の8月の気候の分析</h3>
<ul>
<li><p>
データの一部
</p>
<font size=5>
loadNamespace(x) でエラー: 
  ‘stargazer’ という名前のパッケージはありません

</font></li>

</ul>

</section>
<section>
<ul>
<li>気温を説明する5種類の線形回帰モデルを検討
<ul>
<li>モデル1 : 気温 = F(気圧)</li>
<li>モデル2 : 気温 = F(日射)</li>
<li>モデル3 : 気温 = F(気圧, 日射)</li>
<li>モデル4 : 気温 = F(気圧, 日射, 湿度)</li>
<li>モデル5 : 気温 = F(気圧, 日射, 雲量)</li>

</ul></li>

</ul>
</section>
<section id="slide-org517a733">
<h3 id="org517a733">分析の視覚化</h3>
<ul>
<li><p>
関連するデータの散布図
</p></li>

</ul>


<div id="orgd23d214" class="figure">
<p><img src="figs/05_pairs.png" alt="05_pairs.png" />
</p>
<p><span class="figure-number">Figure 1: </span>散布図</p>
</div>

</section>
<section>
<ul>
<li><p>
観測値とあてはめ値の比較
</p></li>

</ul>


<div id="org301c455" class="figure">
<p><img src="figs/05_models.png" alt="05_models.png" />
</p>
<p><span class="figure-number">Figure 2: </span>モデルの比較</p>
</div>
</section>
<section id="slide-orgdd285b4">
<h3 id="orgdd285b4">寄与率</h3>
<ul>
<li><p>
<b>決定係数</b> (R-squared)
</p>
<blockquote>
<div>
\begin{equation}
  R^2
  =
  1-\frac{\sum_{i=1}^n\hat{\epsilon}_i^2}{\sum_{i=1}^n(y_i-\bar{y})^2}
\end{equation}

</div>
</blockquote></li>
<li><p>
<b>自由度調整済み決定係数</b> (adjusted R-squared)
</p>
<blockquote>
<div>
\begin{equation}
  \bar{R}^2
  =
  1-\frac{\frac{1}{n{-}p{-}1}\sum_{i=1}^n\hat{\epsilon}_i^2}
  {\frac{1}{n{-}1}\sum_{i=1}^n(y_i-\bar{y})^2}
\end{equation}

</div>
</blockquote>
<ul>
<li>不偏分散で補正</li>

</ul></li>

</ul>
</section>
<section id="slide-org134c742">
<h3 id="org134c742">モデルの評価</h3>
<ul>
<li><p>
決定係数(\(R^{2}\), Adjusted \(R^{2}\))
</p>
<font size=4>
loadNamespace(x) でエラー: 
  ‘stargazer’ という名前のパッケージはありません

</font></li>

</ul>
</section>
<section id="slide-org4f680b9">
<h3 id="org4f680b9">\(F\)統計量による検定</h3>
<ul>
<li>説明変数のうち1つでも役に立つか否かを検定する
<ul>
<li>帰無仮説 \(H_{0}\): \(\beta_1=\dotsb=\beta_p=0\)</li>
<li>対立仮説 \(H_{1}\): \(\exists j\;\beta_j\neq0\) (少なくとも1つは役に立つ)</li>

</ul></li>
<li><p>
\(F\)統計量: 決定係数(または残差)を用いて計算
</p>
<blockquote>
<div>
\begin{equation}
  F
  =\frac{n{-}p{-}1}{p}\frac{R^2}{1-R^2}
\end{equation}

</div>
</blockquote></li>
<li>\(p\)値: 自由度 \(p,n{-}p{-}1\) の \(F\)分布で計算</li>

</ul>
</section>
<section id="slide-org90ce9e1">
<h3 id="org90ce9e1">モデルの評価</h3>
<ul>
<li><p>
\(F\)統計量
</p>
<font size=4>
loadNamespace(x) でエラー: 
  ‘stargazer’ という名前のパッケージはありません

</font></li>

</ul>
</section>
<section id="slide-org64e6926">
<h3 id="org64e6926">\(t\)統計量による検定</h3>
<ul>
<li>回帰係数 \(\beta_j\) が回帰式に寄与するか否かを検定する
<ul>
<li>帰無仮説 \(H_{0}\): \(\beta_j=0\)</li>
<li>対立仮説 \(H_{1}\): \(\beta_j\neq0\) (\(\beta_j\) は役に立つ)</li>

</ul></li>
<li><p>
\(t\)統計量: 各係数ごと，\(\zeta\) は \((X^{\mathsf{T}} X)^{-1}\) の対角成分
</p>
<blockquote>
<div>
\begin{equation}
  t=\frac{\hat{\beta}_j}{\hat{\sigma}\zeta_{j}}
\end{equation}

</div>
</blockquote></li>
<li>\(p\)値: 自由度 \(n{-}p{-}1\) の \(t\)分布を用いて計算</li>

</ul>
</section>
<section id="slide-org5716f43">
<h3 id="org5716f43">モデルの評価</h3>
<ul>
<li><p>
\(t\)統計量
</p>
<font size=4>
loadNamespace(x) でエラー: 
  ‘stargazer’ という名前のパッケージはありません

</font></li>

</ul>
</section>
<section id="slide-orgb7a2e33">
<h3 id="orgb7a2e33">診断プロットによる評価</h3>
<ul>
<li><p>
モデル4
</p></li>

</ul>


<div id="org4ac621f" class="figure">
<p><img src="figs/05_diag_model4.png" alt="05_diag_model4.png" />
</p>
<p><span class="figure-number">Figure 3: </span>モデル4の診断</p>
</div>
</section>
<section>
<ul>
<li><p>
モデル5
</p></li>

</ul>


<div id="orge10d958" class="figure">
<p><img src="figs/05_diag_model5.png" alt="05_diag_model5.png" />
</p>
<p><span class="figure-number">Figure 4: </span>モデル5の診断</p>
</div>
</section>
</section>
<section>
<section id="slide-orgfc651e6">
<h2 id="orgfc651e6">回帰モデルによる予測</h2>
<div class="outline-text-2" id="text-orgfc651e6">
</div>
</section>
<section id="slide-orgcee06c1">
<h3 id="orgcee06c1">予測</h3>
<ul>
<li><p>
新しいデータ (説明変数) \(\boldsymbol{x}\) に対する <b>予測値</b>
</p>
<blockquote>
<div>
\begin{equation}
  \hat{y}
  =
  (1,\boldsymbol{x}^{\mathsf{T}})\hat{\boldsymbol{\beta}},
  \qquad
  \hat{\boldsymbol{\beta}}
  =
  (X^{\mathsf{T}}X)^{-1}
  X^{\mathsf{T}}\boldsymbol{y}
\end{equation}

</div>
</blockquote></li>
<li><p>
予測値は元データの目的変数の重み付け線形和
</p>
<blockquote>
<div>
\begin{equation}
  \hat{y}
  =
  \boldsymbol{w}(\boldsymbol{x})^{\mathsf{T}}\boldsymbol{y},
  \qquad
  \boldsymbol{w}(\boldsymbol{x})^{\mathsf{T}}
  =
  (1,\boldsymbol{x}^{\mathsf{T}})
  (X^{\mathsf{T}}X)^{-1}
  X^{\mathsf{T}}
\end{equation}

</div>
</blockquote>
<ul>
<li>重みは元データと新規データの説明変数で決定</li>

</ul></li>

</ul>
</section>
<section id="slide-org8fc863f">
<h3 id="org8fc863f">予測値の性質</h3>
<ul>
<li><p>
推定量は以下の性質をもつ多変量正規分布
</p>
<blockquote>
<div>
\begin{align}
  \mathbb{E}[\hat{\boldsymbol{\beta}}]
  &=\boldsymbol{\beta}\\
  \mathrm{Cov}(\hat{\boldsymbol{\beta}})
  &=\sigma^{2}(X^{\mathsf{T}}X)^{-1}
\end{align}

</div>
</blockquote></li>
<li><p>
この性質を利用して以下の3つの値の違いを評価
</p>
<blockquote>
<div>
\begin{align}
  \hat{y}&=(1,\boldsymbol{x}^{\mathsf{T}})\hat{\boldsymbol{\beta}}
  &&\text{(回帰式による予測値)}\\
  \tilde{y}&=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}
  &&\text{(最適な予測値)}\\
  y&=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}+\epsilon
  &&\text{(観測値)}
\end{align}

</div>
</blockquote>
<ul>
<li>\(\hat{y}\) と \(y\) は独立な正規分布に従うことに注意</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org8f3e07b">
<h2 id="org8f3e07b">信頼区間</h2>
<div class="outline-text-2" id="text-org8f3e07b">
</div>
</section>
<section id="slide-orgf550535">
<h3 id="orgf550535">最適な予測値との差</h3>
<ul>
<li><p>
差の分布は以下の平均・分散をもつ正規分布に従う
</p>
<blockquote>
<div>
\begin{align}
  \mathbb{E}[\tilde{y}-\hat{y}]
  &=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}
    -(1,\boldsymbol{x}^{\mathsf{T}})\mathbb{E}[\hat{\boldsymbol{\beta}}]
    =0\\
  \mathrm{Var}(\tilde{y}-\hat{y})
  &=\underbrace{\sigma^{2}(1,\boldsymbol{x}^{\mathsf{T}})(X^{\mathsf{T}}X)^{-1}
    (1,\boldsymbol{x}^{\mathsf{T}})^{\mathsf{T}}}_{\text{\(\hat{\boldsymbol{\beta}}\)の推定誤差による分散}}
    =\sigma^{2}\gamma_{c}(\boldsymbol{x})^{2}
\end{align}

</div>
</blockquote></li>
<li><p>
正規化による表現
</p>
<blockquote>
<div>
\begin{equation}
  \frac{\tilde{y}-\hat{y}}{\sigma\gamma_{c}(\boldsymbol{x})}
  \sim \mathcal{N}(0,1)
\end{equation}

</div>
</blockquote></li>

</ul>
</section>
<section id="slide-org13d797f">
<h3 id="org13d797f">信頼区間</h3>
<ul>
<li><p>
未知の分散を不偏分散で推定
</p>
<blockquote>
<div>
\begin{equation}
  Z=
  \frac{\tilde{y}-\hat{y}}{\hat{\sigma}\gamma_{c}(\boldsymbol{x})}
  \sim \mathcal{T}(n{-}p{-}1) 
  \quad (\text{\(t\)分布})
\end{equation}

</div>
</blockquote></li>
<li><p>
確率 \(\alpha\) の信頼区間
</p>
<blockquote>
<div>
\begin{equation}
  \mathcal{I}^{c}_{\alpha}
  =
  \left(
    \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x}),\;
    \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x})
  \right)
\end{equation}

</div>

<div>
\begin{equation}
  P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
  =\alpha
\end{equation}

</div>
</blockquote>
<ul>
<li>最適な予測値 \(\tilde{y}\) が入ることが期待される区間</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgff5a4d3">
<h2 id="orgff5a4d3">予測区間</h2>
<div class="outline-text-2" id="text-orgff5a4d3">
</div>
</section>
<section id="slide-org29fd4de">
<h3 id="org29fd4de">観測値との差</h3>
<ul>
<li><p>
差の分布は以下の平均・分散をもつ正規分布に従う
</p>
<blockquote>
<div>
\begin{align}
  \mathbb{E}[y-\hat{y}]
  &=(1,\boldsymbol{x}^{\mathsf{T}})\boldsymbol{\beta}
    +\mathbb{E}[\boldsymbol{\epsilon}]
    -(1,\boldsymbol{x}^{\mathsf{T}})
    \mathbb{E}[\hat{\boldsymbol{\beta}}]
    =0\\
  \mathrm{Var}(y-\hat{y})
  &=\underbrace{\sigma^{2}
    (1,\boldsymbol{x}^{\mathsf{T}})(X^{\mathsf{T}}X)^{-1}
    (1,\boldsymbol{x}^{\mathsf{T}})^{\mathsf{T}}
    }_{\text{\(\hat{\boldsymbol{\beta}}\)の推定誤差による分散}}
    +\underbrace{\sigma^{2}}_{\text{誤差の分散}}
    =\sigma^{2}\gamma_{p}(\boldsymbol{x})^{2}
\end{align}

</div>
</blockquote></li>
<li><p>
正規化による表現
</p>
<blockquote>
<div>
\begin{equation}
  \frac{y-\hat{y}}{\sigma\gamma_{p}(\boldsymbol{x})}
  \sim \mathcal{N}(0,1)
\end{equation}

</div>
</blockquote></li>

</ul>
</section>
<section id="slide-org22c5e99">
<h3 id="org22c5e99">予測区間</h3>
<ul>
<li><p>
未知の分散を不偏分散で推定
</p>
<blockquote>
<div>
\begin{equation}
  Z=
  \frac{y-\hat{y}}{\hat{\sigma}\gamma_{p}(\boldsymbol{x})}
  \sim \mathcal{T}(n{-}p{-}1) 
  \quad (\text{\(t\)分布})
\end{equation}

</div>
</blockquote></li>
<li><p>
確率 \(\alpha\) の予測区間 
</p>
<blockquote>
<div>
\begin{equation}
  \mathcal{I}^{p}_{\alpha}
  =
  \left(
    \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x}),\;
    \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x})
  \right)
\end{equation}

</div>

<div>
\begin{equation}
  P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
  =\alpha
\end{equation}

</div>
</blockquote>

<ul>
<li>観測値 \(y\) が入ることが期待される区間</li>
<li>\(\gamma_{p}>\gamma_{c}\) なので信頼区間より広くなる</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgb6e4c37" data-background="#fef4f4">
<h2 id="orgb6e4c37">実習</h2>
</section>
<section id="slide-orgf296aec">
<h3 id="orgf296aec">R : 予測値と区間推定</h3>
<ul>
<li><p>
関数 <code>stats::predict()</code> を用いた予測
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#12514;&#12487;&#12523;&#12398;&#20316;&#25104;</span>
toy_train <span style="color: #bd93f9;">&lt;-</span> tibble(x1 = ..., x2 = ..., y = ...)
toy_lm  <span style="color: #bd93f9;">&lt;-</span> lm(y ~ x1 + x2, data = toy_train) 
toy_train_fitted  <span style="color: #bd93f9;">&lt;-</span> predict(toy_lm) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#12354;&#12390;&#12399;&#12417;&#20516;&#12398;&#35336;&#31639;</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#26032;&#12375;&#12356;&#12487;&#12540;&#12479;&#12398;&#20104;&#28204;</span>
toy_test <span style="color: #bd93f9;">&lt;-</span> tibble(x1 = ..., x2 = ...) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20104;&#28204;&#12375;&#12383;&#12356;&#12487;&#12540;&#12479;&#12398;&#35500;&#26126;&#22793;&#25968;</span>
toy_test_fitted <span style="color: #bd93f9;">&lt;-</span> predict(toy_lm, <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20104;&#28204;&#20516;&#12398;&#35336;&#31639;</span>
                           newdata = toy_test) 
toy_test_conf <span style="color: #bd93f9;">&lt;-</span> predict(toy_lm, newdata = toy_test, <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20449;&#38972;&#21306;&#38291;</span>
                         interval=<span style="color: #f1fa8c;">"confidence"</span>, level=0.95) 
toy_test_pred <span style="color: #bd93f9;">&lt;-</span> predict(toy_lm, newdata = toy_test, <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20104;&#28204;&#21306;&#38291;</span>
                         interval=<span style="color: #f1fa8c;">"prediction"</span>, level=0.95) 
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#20449;&#38972;&#21306;&#38291;&#65292;&#20104;&#28204;&#21306;&#38291;&#12398;&#27700;&#28310;&#12398;&#26082;&#23450;&#20516;&#12399;0.95</span>
</pre>
</div></li>

</ul>
</section>
<section id="slide-orgde5cda9">
<h3 id="orgde5cda9">R : モデルからの予測</h3>
<ul>
<li><p>
東京の気候データによる例
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> 9,10&#26376;&#12398;&#12487;&#12540;&#12479;&#12391;&#12514;&#12487;&#12523;&#12434;&#27083;&#31689;&#12375;&#65292;8,11&#26376;&#12398;&#12487;&#12540;&#12479;&#12434;&#20104;&#28204;</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#12487;&#12540;&#12479;&#12398;&#25972;&#29702;</span>
tw_data <span style="color: #bd93f9;">&lt;-</span> read_csv(<span style="color: #f1fa8c;">"data/tokyo_weather.csv"</span>)
tw_train <span style="color: #bd93f9;">&lt;-</span> tw_data |&gt; <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#12514;&#12487;&#12523;&#25512;&#23450;&#29992;&#12487;&#12540;&#12479;</span>
  filter(month <span style="color: #bd93f9;">%in%</span> c(9,10)) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">%in% &#12399;&#38598;&#21512;&#12395;&#21547;&#12416;&#12363;&#12393;&#12358;&#12363;&#12434;&#21028;&#23450;</span>
tw_test  <span style="color: #bd93f9;">&lt;-</span> tw_data |&gt; <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20104;&#28204;&#29992;&#12487;&#12540;&#12479;</span>
  filter(month <span style="color: #bd93f9;">%in%</span> c(8,11))
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#12514;&#12487;&#12523;&#12398;&#27083;&#31689;</span>
tw_model <span style="color: #bd93f9;">&lt;-</span> temp ~ solar + press <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#12514;&#12487;&#12523;&#12398;&#23450;&#32681; </span>
tw_lm <span style="color: #bd93f9;">&lt;-</span> lm(tw_model, data = tw_train) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#12514;&#12487;&#12523;&#12398;&#25512;&#23450;</span>
summary(tw_lm) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#12514;&#12487;&#12523;&#12398;&#35413;&#20385;</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#12354;&#12390;&#12399;&#12417;&#20516;&#12398;&#35336;&#31639;</span>
tw_train_fitted <span style="color: #bd93f9;">&lt;-</span> tw_train |&gt;
  mutate(fitted = predict(tw_lm)) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#12487;&#12540;&#12479;&#12398;&#12354;&#12390;&#12399;&#12417;&#20516;</span>
tw_test_fitted <span style="color: #bd93f9;">&lt;-</span> tw_test  |&gt;
  mutate(fitted = predict(tw_lm, newdata = tw_test)) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20104;&#28204;</span>
</pre>
</div></li>

</ul>

</section>
<section>
<ul>
<li><p>
グラフ表示の例
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#20104;&#28204;&#32080;&#26524;&#12434;&#22259;&#31034;</span>
bind_rows(tw_train_fitted, tw_test_fitted) |&gt; <span style="color: #6272a4;"># </span><span style="color: #6272a4;">2&#12388;&#12398;&#12487;&#12540;&#12479;&#12501;&#12524;&#12540;&#12512;&#12434;&#32080;&#21512;</span>
  mutate(month = as_factor(month)) |&gt; <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#26376;&#12434;&#22240;&#23376;&#21270;&#12375;&#12390;&#34920;&#31034;&#12395;&#21033;&#29992;</span>
  ggplot(aes(x = fitted, y = temp)) +
  geom_point(aes(colour = month, shape = month)) + <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#26376;&#12372;&#12392;&#12395;&#33394;&#12392;&#24418;&#12434;&#22793;&#12360;&#12427;</span>
  geom_abline(slope = 1, intercept = 0, <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20104;&#28204;&#12364;&#23436;&#20840;&#12395;&#27491;&#12375;&#12356;&#22580;&#21512;&#12398;&#12460;&#12452;&#12489;&#32218;</span>
              colour = <span style="color: #f1fa8c;">"gray"</span>) +
  labs(y = <span style="color: #f1fa8c;">"observed"</span>)
</pre>
</div></li>

</ul>
</section>
<section id="slide-org54c061c">
<h3 id="org54c061c">R : 区間表示のための関数</h3>
<ul>
<li><p>
関数 <code>ggplot2::geom_errorbar()</code> : 区間の表示
</p>
<div class="org-src-container">

<pre class="src src-R">geom_errorbar(
  mapping = <span style="color: #8be9fd; font-style: italic;">NULL</span>,
  data = <span style="color: #8be9fd; font-style: italic;">NULL</span>,
  stat = <span style="color: #f1fa8c;">"identity"</span>,
  position = <span style="color: #f1fa8c;">"identity"</span>,
  ...,
  na.rm = <span style="color: #8be9fd; font-style: italic;">FALSE</span>,
  orientation = <span style="color: #8be9fd; font-style: italic;">NA</span>,
  show.legend = <span style="color: #8be9fd; font-style: italic;">NA</span>,
  inherit.aes = <span style="color: #8be9fd; font-style: italic;">TRUE</span>
)
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> mapping: &#21306;&#38291;&#12434;&#34920;&#12377;&#12383;&#12417;&#12395; xmin,xmax &#12414;&#12383;&#12399; ymin,ymax &#12434;&#19982;&#12360;&#12427;</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> data: &#12487;&#12540;&#12479;&#12501;&#12524;&#12540;&#12512;</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> ...: &#12381;&#12398;&#20182;&#12398;&#25551;&#30011;&#12458;&#12503;&#12471;&#12519;&#12531;</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> orientation: &#29305;&#21029;&#12394;&#22580;&#21512;&#12395;&#25351;&#23450; (&#19968;&#33324;&#12395;&#21521;&#12365;&#12399; mapping &#12391;&#33258;&#21205;&#30340;&#27770;&#23450;)</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#35443;&#32048;&#12399; '?ggplot2::geom_errorbar' &#12434;&#21442;&#29031;</span>
</pre>
</div>
<ul>
<li>関数 <code>stats::predict()</code> の返り値 &rsquo;lwr/upr&rsquo; を用いればよい</li>

</ul></li>

</ul>
</section>
<section id="slide-orga80c377" data-background="#fef4f4">
<h3 id="orga80c377">練習問題</h3>
<ul>
<li><p>
東京の気候データを用いて以下の実験を試みなさい
</p>
<ul>
<li>8月のデータで回帰式を推定する</li>
<li>上記のモデルで9月のデータを予測する</li>

</ul>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#29305;&#23450;&#12398;&#26376;&#12398;&#12487;&#12540;&#12479;&#12434;&#21462;&#12426;&#20986;&#12377;&#12395;&#12399;&#65292;&#20363;&#12360;&#12400;&#20197;&#19979;&#12398;&#12424;&#12358;&#12395;&#12377;&#12428;&#12400;&#12424;&#12356;</span>
tw_data <span style="color: #bd93f9;">&lt;-</span> read_csv(<span style="color: #f1fa8c;">"data/tokyo_weather.csv"</span>)
tw_train <span style="color: #bd93f9;">&lt;-</span> tw_data |&gt; filter(month == 8) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#21336;&#19968;&#12398;&#25968;&#23383;&#12392;&#27604;&#36611;</span>
tw_test  <span style="color: #bd93f9;">&lt;-</span> tw_data |&gt; filter(month <span style="color: #bd93f9;">%in%</span> c(9,10)) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#38598;&#21512;&#12392;&#27604;&#36611;</span>
</pre>
</div></li>

</ul>
</section>
</section>
<section>
<section id="slide-org52badfc">
<h2 id="org52badfc">発展的なモデル</h2>
<div class="outline-text-2" id="text-org52badfc">
</div>
</section>
<section id="slide-org0a97199">
<h3 id="org0a97199">非線形性を含むモデル</h3>
<ul>
<li>目的変数 \(y\)</li>
<li>説明変数 \(x_1,\dotsc,x_p\)</li>
<li>説明変数の追加で対応可能
<ul>
<li>交互作用 (交差項) : \(x_ix_j\) のような説明変数の積</li>
<li>非線形変換 : \(\log(x_k)\) のような関数による変換</li>

</ul></li>

</ul>
</section>
<section id="slide-orgc33b964">
<h3 id="orgc33b964">カテゴリカル変数を含むモデル</h3>
<ul>
<li>数値ではないデータ
<ul>
<li><span style="color:green;">悪性良性</span></li>
<li><span style="color:green;">血液型</span></li>

</ul></li>
<li>適切な方法で数値に変換して対応:
<ul>
<li>2値の場合は 1,0 (真，偽) を割り当てる
<ul>
<li>悪性 : 1</li>
<li>良性 : 0</li>

</ul></li>
<li>3値以上の場合は <b>ダミー変数</b> を利用する (カテゴリ数-1個)
<ul>
<li>A型 : (1,0,0)</li>
<li>B型 : (0,1,0)</li>
<li>O型 : (0,0,1)</li>
<li>AB型 : (0,0,0)</li>

</ul></li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orgcbd62ad" data-background="#fef4f4">
<h2 id="orgcbd62ad">実習</h2>
</section>
<section id="slide-orgdedc35e" data-background="#fef4f4">
<h3 id="orgdedc35e">R : 線形でないモデル式の書き方</h3>
<ul>
<li>交互作用を記述するためには特殊な記法がある</li>
<li>非線形変換はそのまま関数を記述すればよい</li>
<li><p>
1つの変数の多項式は関数 <code>I()</code> を用いる
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#30446;&#30340;&#22793;&#25968; Y, &#35500;&#26126;&#22793;&#25968; X1,X2,X3</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#20132;&#20114;&#20316;&#29992;&#12434;&#21547;&#12416;&#24335; (formula) &#12398;&#26360;&#12365;&#26041;</span>
Y ~ X1 + X1:X2       <span style="color: #6272a4;"># </span><span style="color: #6272a4;">X1 + X1*X2</span>
Y ~ X1 * X2          <span style="color: #6272a4;"># </span><span style="color: #6272a4;">X1 + X2 + X1*X2</span>
Y ~ (X1 + X2 + X3)^2 <span style="color: #6272a4;"># </span><span style="color: #6272a4;">X1 + X2 + X3 + X1*X2 + X2*X3 + X3*X1</span>
<span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#38750;&#32218;&#24418;&#22793;&#25563;&#12434;&#21547;&#12416;&#24335; (formula) &#12398;&#26360;&#12365;&#26041;</span>
Y ~ f(X1)            <span style="color: #6272a4;"># </span><span style="color: #6272a4;">f(X1) (f&#12399;&#20219;&#24847;&#12398;&#38306;&#25968;)</span>
Y ~ X1 + I(X2^2)     <span style="color: #6272a4;"># </span><span style="color: #6272a4;">X1 + X2^2</span>
</pre>
</div></li>

</ul>
</section>
<section id="slide-org9503978" data-background="#fef4f4">
<h3 id="org9503978">R : カテゴリカル変数の取り扱い</h3>
<ul>
<li>何も宣言しなくても通常は適切に対応してくれる</li>
<li><p>
陽に扱う場合は関数 <code>factor()</code> を利用する
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> factor&#23646;&#24615;&#12398;&#19982;&#12360;&#26041;</span>
X <span style="color: #bd93f9;">&lt;-</span> c(<span style="color: #f1fa8c;">"A"</span>, <span style="color: #f1fa8c;">"S"</span>, <span style="color: #f1fa8c;">"A"</span>, <span style="color: #f1fa8c;">"B"</span>, <span style="color: #f1fa8c;">"D"</span>)
Y <span style="color: #bd93f9;">&lt;-</span> c(85, 100, 80, 70, 30)
toy_data1 <span style="color: #bd93f9;">&lt;-</span> tibble(X, Y)
toy_data2 <span style="color: #bd93f9;">&lt;-</span> toy_data1 |&gt; <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#22240;&#23376;&#21270;</span>
  mutate(X2 = factor(X))  <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#38306;&#25968;as_factor()&#12434;&#29992;&#12356;&#12390;&#12418;&#12424;&#12356;</span>
str(toy_data2) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#20316;&#25104;&#12375;&#12383;&#12487;&#12540;&#12479;&#12501;&#12524;&#12540;&#12512;&#12398;&#32032;&#24615;&#12434;&#35211;&#12427;</span>
toy_data3 <span style="color: #bd93f9;">&lt;-</span> toy_data2 |&gt; <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#38918;&#24207;&#20184;&#12365;(levels)&#12398;&#22240;&#23376;&#21270;</span>
  mutate(X3 = factor(X, levels=c(<span style="color: #f1fa8c;">"S"</span>,<span style="color: #f1fa8c;">"A"</span>,<span style="color: #f1fa8c;">"B"</span>,<span style="color: #f1fa8c;">"C"</span>,<span style="color: #f1fa8c;">"D"</span>)))
str(toy_data3) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">toy_data2&#12392;&#12399;factor&#12398;&#38918;&#24207;&#12364;&#30064;&#12394;&#12427;</span>
toy_data4 <span style="color: #bd93f9;">&lt;-</span> toy_data2 |&gt;
  mutate(Y2 = factor(Y &gt; 60)) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#26465;&#20214;&#12395;&#12424;&#12427;&#22240;&#23376;&#21270;</span>
str(toy_data4) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#26465;&#20214;&#12398;&#30495;&#20605;&#12391;2&#20516;&#12395;&#39006;&#21029;&#12373;&#12428;&#12427;</span>
</pre>
</div></li>

</ul>
</section>
<section id="slide-org1c11cf1" data-background="#fef4f4">
<h3 id="org1c11cf1">練習問題</h3>
<ul>
<li>東京の気候データ(9-11月)を用いて
気温を回帰する以下のモデルを検討しなさい
<ul>
<li>日射量，気圧，湿度の線形回帰モデル</li>
<li>湿度の対数を考えた線形回帰モデル</li>
<li>最初のモデルにそれぞれの交互作用を加えたモデル</li>

</ul></li>
<li>東京の気候データ(1年分)を用いて
気温を回帰する以下のモデルを検討しなさい
<ul>
<li>降水の有無を表すカテゴリカル変数を用いたモデル <br />
(雨が降ると気温が変化することを検証する)</li>
<li>上記に月をカテゴリカル変数として加えたモデル <br />
(月毎の気温の差を考慮する)</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-org71d2a63">
<h2 id="org71d2a63">補足</h2>
</section>
<section id="slide-org72529bb">
<h3 id="org72529bb">R : モデルの探索</h3>
<ul>
<li>変数が増えるとモデルの比較が困難</li>
<li><p>
関数 <code>stats::step()</code> で自動化することができる
</p>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#12514;&#12487;&#12523;&#12398;&#25506;&#32034;</span>
adv_data <span style="color: #bd93f9;">&lt;-</span> read_csv(<span style="color: #f1fa8c;">'https://www.statlearning.com/s/Advertising.csv'</span>)
summary(lm(sales ~ radio, data = adv_data))
summary(lm(sales ~ TV + radio, data = adv_data))
summary(lm(sales ~ TV + radio + newspaper, data = adv_data))
summary(adv_init <span style="color: #bd93f9;">&lt;-</span> lm(sales ~ TV * radio * newspaper, data = adv_data))
adv_opt <span style="color: #bd93f9;">&lt;-</span> step(adv_init) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#26368;&#22823;&#12398;&#12514;&#12487;&#12523;&#12363;&#12425;&#21066;&#28187;&#22679;&#21152;&#12395;&#12424;&#12427;&#25506;&#32034;</span>
summary(adv_opt) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#25506;&#32034;&#12373;&#12428;&#12383;(&#28310;)&#26368;&#36969;&#12394;&#12514;&#12487;&#12523;&#12398;&#30906;&#35469;</span>
</pre>
</div>
<ul>
<li>全探索ではないので最適とは限らないことに注意は必要</li>

</ul></li>

</ul>
</section>
<section id="slide-org3f9a675">
<h3 id="org3f9a675">R : package::broom</h3>
<ul>
<li>関数 base::summary() の tidyverse 版</li>
<li><p>
関数 stats::lm() などの結果を tibble 形式で表示
</p>
<ul>
<li>関数 broom::tidy : 推定結果のまとめ</li>
<li>関数 broom::glance : 評価指標(統計量)のまとめ</li>
<li>関数 broom::augment : 入出力データのまとめ</li>

</ul>
<div class="org-src-container">

<pre class="src src-R"><span style="color: #6272a4; font-weight: bold;">#</span><span style="color: #6272a4; font-weight: bold;">'</span><span style="color: #6272a4;"> &#25512;&#23450;&#32080;&#26524;&#12398; tibble &#24418;&#24335;&#12391;&#12398;&#34920;&#31034;</span>
broom::tidy(adv_opt) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">coef(summary(adv_opt)) &#12392;&#21516;&#12376;&#20869;&#23481;</span>
broom::glance(adv_opt) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#27770;&#23450;&#20418;&#25968;&#12420;F&#20516;&#12394;&#12393;&#12434;&#25972;&#29702;</span>
broom::augment(adv_opt) <span style="color: #6272a4;"># </span><span style="color: #6272a4;">&#12354;&#12390;&#12399;&#12417;&#20516;&#12539;&#27531;&#24046;&#12394;&#12393;&#12434;&#25972;&#29702;</span>
</pre>
</div></li>

</ul>
</section>
<section id="slide-org3709ab0">
<h3 id="org3709ab0">R : package::car</h3>
<ul>
<li>回帰モデルの評価
<ul>
<li>与えられたデータの再現</li>
<li>新しいデータの予測</li>

</ul></li>
<li><p>
モデルの再構築のための視覚化
</p>
<ul>
<li><b>residual plots</b>: 
説明変数・予測値と残差の関係</li>
<li><b>marginal-model plots</b>:
説明変数と目的変数・モデルの関係</li>
<li><b>added-variable plots</b>:
説明変数・目的変数をその他の変数で回帰したときの残差の関係</li>
<li><b>component+residual plots</b>:
説明変数とそれ以外の説明変数による残差の関係</li>

</ul>

<p>
などが用意されている
</p></li>

</ul>
</section>
<section id="slide-orgedf0603">
<h3 id="orgedf0603">例題</h3>
<ul>
<li>これまでに用いたデータでモデルを更新して評価してみよう
<ul>
<li>変数間の線形回帰の関係について仮説を立てる</li>
<li>モデルのあてはめを行い評価する
<ul>
<li>説明力があるのか? (\(F\)統計量，\(t\)統計量，決定係数)</li>
<li>残差に偏りはないか? (様々な診断プロット)</li>
<li>変数間の線形関係は妥当か? (様々な診断プロット)</li>

</ul></li>
<li>検討結果を踏まえてモデルを更新する (評価の繰り返し)</li>

</ul></li>

</ul>
</section>
</section>
<section>
<section id="slide-orge8a08c6">
<h2 id="orge8a08c6">次回の予定</h2>
<ul>
<li><b>第1回: 主成分分析の考え方</b></li>
<li>第2回: 分析の評価と視覚化</li>

</ul>
</div>
</div>
<script src="./reveal.js/dist/reveal.js"></script>
<script src="./reveal.js/plugin/notes/notes.js"></script>
<script src="./reveal.js/plugin/search/search.js"></script>
<script src="./reveal.js/plugin/zoom/zoom.js"></script>
<script src="./reveal.js/plugin/menu/menu.js"></script>
<script src="./reveal.js/plugin/spotlight/spotlight.js"></script>
<script src="./reveal.js/plugin/drawer/drawer.js"></script>
<script src="./reveal.js/dist/theme/hidelinks.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: true,
fragmentInURL: true,
hashOneBasedIndex: false,
pdfSeparateFragments: false,
overview: true,

transition: 'fade',
transitionSpeed: 'default',
showNotes: window.location.search.match( /print-pdf/gi ) ? 'separate-page' : false,
spotlight: { size: 80, initialPresentationMode: false, }, drawer: { toggleDrawKey: "d", toggleBoardKey: "c", pathSize: 3, }, keyboard: { 81: function() { RevealSpotlight.toggleSpotlight()}, 87: function() { RevealSpotlight.togglePresentationMode();}, },

// Plugins with reveal.js 4.x
plugins: [ RevealNotes, RevealSearch, RevealZoom, RevealMenu, RevealSpotlight, RevealDrawer ],

// Optional libraries used to extend reveal.js
dependencies: [
]

});
</script>
</body>
</html>
