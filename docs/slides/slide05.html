<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>回帰分析</title>
<meta name="author" content="村田 昇"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/dist/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/oer-reveal.css" id="theme"/>

<link rel="stylesheet" href="./reveal.js/plugin/toc-progress/toc-progress.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/toc-style.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/fonts/source-sans-pro/source-sans-pro.css"/>

<link rel="stylesheet" href="./reveal.js/plugin/accessibility/helper.css"/>

<link rel="stylesheet" href="./reveal.js/dist/theme/mycourse.css"/>
<link rel="stylesheet" href="./reveal.js/plugin/highlight/zenburn.css"/>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide" data-state="no-toc-progress">
<!-- This is an HTML template for the title slide. -->
<!-- Embed logos as necessary. -->
<!-- <a class="nooutlink" href="url"><img class="state-background your-logo-class" src="whatever.png" alt="Whatever" /></a> -->
<div class="talk-title">
    <h1 class="no-toc-progress">回帰分析</h1>
</div>
<div class="talk-subtitle">
    <p>予測と発展的なモデル</p>
</div>
<div class="keyboard-usage">
    <p>(Press <code>?</code> for help, <code>n</code> and <code>p</code> for next and previous slide)</p>
</div>
<div class="talk-author">
  <p>村田 昇<br />
  XXXX.XX.XX</p>
</div>

</section>

<section>
<section id="slide-orgb32723b">
<h2 id="orgb32723b">講義の予定</h2>
<ul>
<li>第1日: 回帰モデルの考え方と推定</li>
<li>第2日: モデルの評価</li>
<li><b>第3日: モデルによる予測と発展的なモデル</b></li>

</ul>

<div class="slide-footer"><br></div>
</section>
</section>
<section>
<section id="slide-org290cbd9">
<h2 id="org290cbd9">回帰分析の復習</h2>
<div class="outline-text-2" id="text-org290cbd9">
</div>
<div class="slide-footer"><br></div>
</section>
<section id="slide-orgc7d9ec6">
<h3 id="orgc7d9ec6">線形回帰モデル</h3>
<ul>
<li><b>目的変数</b> を <b>説明変数</b> で説明する関係式を構成:
<ul>
<li>説明変数: \(x_1,\dotsc,x_p\) (p次元)</li>
<li>目的変数: \(y\) (1次元)</li>

</ul></li>
<li><p>
<b>回帰係数</b> \(\beta_0,\beta_1,\dotsc,\beta_p\) を用いた一次式:
</p>
<div>
\begin{equation}
  y=\beta_0+\beta_1x_1+\dotsb+\beta_px_p
\end{equation}

</div></li>

<li><p>
<b>誤差項</b> を含む確率モデルで観測データを表現: 
</p>
<div>
\begin{equation}
  y_i=\beta_0+\beta_1 x_{i1}+\cdots+\beta_px_{ip}+\epsilon_i
  \quad (i=1,\dotsc,n)
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-orgcdb4c8e">
<h3 id="orgcdb4c8e">問題設定</h3>
<ul>
<li><p>
確率モデル:
</p>
<div>
\begin{equation}
  \boldsymbol{y}
  =\boldsymbol{X}\boldsymbol{\beta}+\boldsymbol{\epsilon}
\end{equation}

</div></li>

<li><p>
式の評価: <b>残差平方和</b> の最小による推定
</p>
<div>
\begin{equation}
  S(\boldsymbol{\beta})
  =(\boldsymbol{y}-\boldsymbol{X}\boldsymbol{\beta})^\top
  (\boldsymbol{y}-\boldsymbol{X}\boldsymbol{\beta})
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org1bdeb4b">
<h3 id="org1bdeb4b">解</h3>
<ul>
<li><p>
解の条件: <b>正規方程式</b>
</p>
<div>
\begin{equation}
  \boldsymbol{X}^\top\boldsymbol{X}\boldsymbol{\beta}
  =\boldsymbol{X}^\top\boldsymbol{y}
\end{equation}

</div></li>

<li><p>
解の一意性: <b>Gram 行列</b> \(\boldsymbol{X}^\top\boldsymbol{X}\) が正則
</p>
<div>
\begin{equation}
  \hat{\boldsymbol{\beta}}
  =
  (\boldsymbol{X}^\top\boldsymbol{X})^{-1}
  \boldsymbol{X}^\top\boldsymbol{y}  
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-orgb78243d">
<h3 id="orgb78243d">寄与率</h3>
<ul>
<li><p>
<b>決定係数 (R-squared)</b>:
</p>
<div>
\begin{equation}
  R^2
  =
  1-\frac{\sum_{i=1}^n\hat{\epsilon}_i^2}{\sum_{i=1}^n(y_i-\bar{y})^2}
\end{equation}

</div></li>

<li><p>
<b>自由度調整済み決定係数 (adjusted R-squared)</b>:
</p>
<div>
\begin{equation}
  \bar{R}^2
  =
  1-\frac{\frac{1}{n{-}p{-}1}\sum_{i=1}^n\hat{\epsilon}_i^2}
  {\frac{1}{n{-}1}\sum_{i=1}^n(y_i-\bar{y})^2}
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-orga4449d8">
<h3 id="orga4449d8">\(t\) -統計量による検定</h3>
<ul>
<li>回帰係数 \(\beta_j\) が回帰式に寄与するか否かを検定する
<ul>
<li>帰無仮説: \(\beta_j=0\)</li>
<li>対立仮説: \(\beta_j\neq0\) (\(\beta_j\) は役に立つ)</li>

</ul></li>
<li><p>
\(t\) -統計量: 各係数ごと，\(\xi\) は \((X^\top X)^{-1}\) の対角成分
</p>
<div>
\begin{equation}
  t=\frac{\hat{\beta}_j}{\hat{\sigma}\sqrt{\xi_j}}
\end{equation}

</div></li>

<li>\(p\) -値: 自由度 \(n{-}p{-}1\) の \(t\) 分布を用いて計算</li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-orgc627727">
<h3 id="orgc627727">\(F\) -統計量による検定</h3>
<ul>
<li>説明変数のうち1つでも役に立つか否かを検定する
<ul>
<li>帰無仮説: \(\beta_1=\dotsb=\beta_p=0\)</li>
<li>対立仮説: \(\exists j\;\beta_j\neq0\) (少なくとも1つは役に立つ)</li>

</ul></li>
<li><p>
\(F\) -統計量: 決定係数(または残差)を用いて計算
</p>
<div>
\begin{equation}
  F
  =\frac{n{-}p{-}1}{p}\frac{R^2}{1-R^2}
\end{equation}

</div></li>

<li>\(p\) -値: 自由度 \(p,n{-}p{-}1\) の \(F\) 分布で計算</li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org04e5b5a" data-background="#EEEEFF">
<h3 id="org04e5b5a">演習: 回帰分析とその評価</h3>
<ul>
<li><a href="./code/06-wine.r">06-wine.r</a> を確認してみよう</li>

</ul>

<div class="slide-footer"><br></div>
</section>
</section>
<section>
<section id="slide-orgeb17d4a">
<h2 id="orgeb17d4a">回帰モデルによる予測</h2>
<div class="outline-text-2" id="text-orgeb17d4a">
</div>
<div class="slide-footer"><br></div>
</section>
<section id="slide-orga8ca699">
<h3 id="orga8ca699">予測</h3>
<ul>
<li><p>
新しいデータ (説明変数) \(\boldsymbol{x}\) に対する予測値
</p>
<div>
\begin{equation}
  \hat{y}
  =
  (1,\boldsymbol{x}^{\top})\hat{\boldsymbol{\beta}},
  \qquad
  \hat{\boldsymbol{\beta}}
  =
  (\boldsymbol{X}^{\top}\boldsymbol{X})^{-1}
  \boldsymbol{X}^{\top}\boldsymbol{y}
\end{equation}

</div></li>

<li><p>
予測値は元データの目的変数の重み付け線形和
</p>
<div>
\begin{equation}
  \hat{y}
  =
  \boldsymbol{w}(\boldsymbol{x})^{\top}\boldsymbol{y}
\end{equation}

</div></li>

</ul>

<ul>
<li><p>
重みは元データと新規データの説明変数で決定
</p>
<div>
\begin{equation}
  \boldsymbol{w}(\boldsymbol{x})^{\top}
  =
  (1,\boldsymbol{x}^{\top})
  (\boldsymbol{X}^{\top}\boldsymbol{X})^{-1}
  \boldsymbol{X}^{\top}
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org902312f">
<h3 id="org902312f">予測値の分布</h3>
<ul>
<li><p>
推定量は以下の性質をもつ多変量正規分布
</p>
<div>
\begin{align}
  \mathbb{E}[\hat{\boldsymbol{\beta}}]
  &=\boldsymbol{\beta}\\
  \mathrm{Cov}(\hat{\boldsymbol{\beta}})
  &=\sigma^{2}(\boldsymbol{X}^{\top}\boldsymbol{X})^{-1}
\end{align}

</div></li>

<li><p>
この性質を利用して以下の3つの値の違いを評価
</p>
<div>
\begin{align}
  \hat{y}&=(1,\boldsymbol{x}^{\top})\hat{\boldsymbol{\beta}}
  &&\text{(回帰式による予測値)}\\
  \tilde{y}&=(1,\boldsymbol{x}^{\top})\boldsymbol{\beta}
  &&\text{(最適な予測値)}\\
  y&=(1,\boldsymbol{x}^{\top})\boldsymbol{\beta}+\epsilon
  &&\text{(観測値)}
\end{align}

</div>

<p>
(\(\hat{y}\) と \(y\) は独立な正規分布に従うことに注意)
</p></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org8125728">
<h3 id="org8125728">最適な予測値との差</h3>
<ul>
<li><p>
差の分布は以下の平均・分散の正規分布
</p>
<div>
\begin{align}
  \mathbb{E}[\tilde{y}-\hat{y}]
  &=\boldsymbol{x}^{\top}\boldsymbol{\beta}
    -\boldsymbol{x}^{\top}\mathbb{E}[\hat{\boldsymbol{\beta}}]
    =0\\
  \mathrm{Var}(\tilde{y}-\hat{y})
  &=\underbrace{\sigma^{2}\boldsymbol{x}^{\top}
    (\boldsymbol{X}^{\top}\boldsymbol{X})^{-1}\boldsymbol{x}
    }_{\text{$\hat{\boldsymbol{\beta}}$の推定誤差による分散}}
    =\sigma^{2}\gamma_{c}(\boldsymbol{x})^{2}
\end{align}

</div></li>

<li><p>
正規化による表現
</p>
<div>
\begin{equation}
  \frac{\tilde{y}-\hat{y}}{\sigma\gamma_{c}(\boldsymbol{x})}
  \sim \mathcal{N}(0,1)
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-orgb59c9f3">
<h3 id="orgb59c9f3">信頼区間</h3>
<ul>
<li><p>
未知の分散を不偏分散で推定
</p>
<div>
\begin{equation}
  Z=
  \frac{\tilde{y}-\hat{y}}{\hat{\sigma}\gamma_{c}(\boldsymbol{x})}
  \sim \mathcal{T}(n{-}p{-}1) 
  \quad (\text{$t$-分布})
\end{equation}

</div></li>

<li><p>
確率 \(\alpha\) の信頼区間 
(最適な予測値 \(\tilde{y}\) が入ることが期待される区間)
</p>
<div>
\begin{equation}
  \left(
    \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x}),\;
    \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{c}(\boldsymbol{x})
  \right)
\end{equation}

</div>

<p>
ただし \(C_{\alpha}\) は以下を満たす定数
</p>
<div>
\begin{equation}
  P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
  =\alpha
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org702831d">
<h3 id="org702831d">観測値との差</h3>
<ul>
<li><p>
差の分布は以下の平均・分散の正規分布
</p>
<div>
\begin{align}
  \mathbb{E}[y-\hat{y}]
  &=\boldsymbol{x}^{\top}\boldsymbol{\beta}
    -\boldsymbol{x}^{\top}\mathbb{E}[\hat{\boldsymbol{\beta}}]
    =0\\
  \mathrm{Var}(y-\hat{y})
  &=\underbrace{\sigma^{2}\boldsymbol{x}^{\top}
    (\boldsymbol{X}^{\top}\boldsymbol{X})^{-1}\boldsymbol{x}
    }_{\text{$\hat{\boldsymbol{\beta}}$の推定誤差による分散}}
    +\underbrace{\sigma^{2}}_{\text{誤差の分散}}
    =\sigma^{2}\gamma_{p}(\boldsymbol{x})^{2}
\end{align}

</div></li>

<li><p>
正規化による表現
</p>
<div>
\begin{equation}
  \frac{y-\hat{y}}{\sigma\gamma_{p}(\boldsymbol{x})}
  \sim \mathcal{N}(0,1)
\end{equation}

</div></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org283c349">
<h3 id="org283c349">予測区間</h3>
<ul>
<li><p>
未知の分散を不偏分散で推定
</p>
<div>
\begin{equation}
  Z=
  \frac{y-\hat{y}}{\hat{\sigma}\gamma_{p}(\boldsymbol{x})}
  \sim \mathcal{T}(n{-}p{-}1) 
  \quad (\text{$t$-分布})
\end{equation}

</div></li>

<li><p>
確率 \(\alpha\) の予測区間
(観測値 \(y\) が入ることが期待される区間)
</p>
<div>
\begin{equation}
  \left(
    \hat{y}-C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x}),\;
    \hat{y}+C_{\alpha}\hat{\sigma}\gamma_{p}(\boldsymbol{x})
  \right)
\end{equation}

</div>

<p>
ただし \(C_{\alpha}\) は以下を満たす定数
</p>
<div>
\begin{equation}
  P(|Z| < {C_{\alpha}} | Z\sim\mathcal{T}(n{-}p{-}1))
  =\alpha
\end{equation}

</div></li>

</ul>

<ul>
<li>\(\gamma_{p}>\gamma_{c}\) なので信頼区間より広くなる</li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org0d47f40" data-background="#EEEEFF">
<h3 id="org0d47f40">演習: 信頼区間と予測区間</h3>
<ul>
<li><a href="./code/06-interval.r">06-interval.r</a> を確認してみよう</li>

</ul>
<div class="slide-footer"><br></div>
</section>
<section id="slide-org0c16629" data-background="#EEEEFF">
<h3 id="org0c16629">演習: モデルの更新</h3>
<ul>
<li><a href="./code/06-model.r">06-model.r</a> を確認してみよう</li>

</ul>

<div class="slide-footer"><br></div>
</section>
</section>
<section>
<section id="slide-orgf5967af">
<h2 id="orgf5967af">発展的なモデル</h2>
<div class="outline-text-2" id="text-orgf5967af">
</div>
<div class="slide-footer"><br></div>
</section>
<section id="slide-org774be42">
<h3 id="org774be42">非線形な関係のモデル化</h3>
<ul>
<li>目的変数 \(Y\)</li>
<li>説明変数 \(X_1,\dotsc,X_p\)</li>
<li>説明変数の追加で対応可能
<ul>
<li>交互作用 (交差項): \(X_iX_j\) のような説明変数の積</li>
<li>非線形変換: \(\log(X_k)\) のような関数による変換</li>

</ul></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org7b72024">
<h3 id="org7b72024">R: 線形でないモデル式の書き方</h3>
<ul>
<li>交互作用を記述するためには特殊な記法がある</li>
<li>非線形変換はそのまま関数を記述すればよい</li>
<li>1つの変数の多項式は関数 <code>I()</code> を用いる</li>

</ul>
<div class="org-src-container">

<pre><code class=" R" >## 目的変数 Y, 説明変数 X1,X2,X3
## 交互作用を含む式 (formula) の書き方
Y ~ X1 + X1:X2       # X1 + X1*X2
Y ~ X1 * X2          # X1 + X2 + X1*X2
Y ~ (X1 + X2 + X3)^2 # X1 + X2 + X3 + X1*X2 + X2*X3 + X3*X1
## 非線形変換を含む式 (formula) の書き方
Y ~ f(X1)            # f(X1) (fは任意の関数)
Y ~ X1 + I(X1^2)     # X1 + X1^2
</code></pre>
</div>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org53be626" data-background="#EEEEFF">
<h3 id="org53be626">演習: 交互作用</h3>
<ul>
<li><a href="./code/06-cross.r">06-cross.r</a> を確認してみよう</li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org042fa07">
<h3 id="org042fa07">カテゴリデータ</h3>
<ul>
<li>悪性良性や血液型などの数値ではないデータ</li>
<li>適切な方法で数値に変換して対応:
<ul>
<li>2値の場合は0,1を割り当てる
<ul>
<li>悪性:1</li>
<li>良性:0</li>

</ul></li>
<li>3値以上の場合は <b>ダミー変数</b> を利用する (カテゴリ数-1個)
<ul>
<li>A型: (1,0,0)</li>
<li>B型: (0,1,0)</li>
<li>O型: (0,0,1)</li>
<li>AB型: (0,0,0)</li>

</ul></li>

</ul></li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org0aa436c">
<h3 id="org0aa436c">R: カテゴリデータの取り扱い</h3>
<ul>
<li>通常は適切に対応してくれる</li>
<li>カテゴリデータとして扱いたい場合は <code>factor()</code> を利用する</li>

</ul>
<div class="org-src-container">

<pre><code class=" R" >## データフレーム mydat1, mydat2, mydat3
## 変数名 X, Y, Z
mydat2 &lt;- transform(mydat1, Y=as.factor(X))
mydat3 &lt;- transform(mydat1, Z=as.factor(X &gt; 0)) 
</code></pre>
</div>

<div class="slide-footer"><br></div>
</section>
<section id="slide-org695fcfd" data-background="#EEEEFF">
<h3 id="org695fcfd">演習: ダミー変数</h3>
<ul>
<li><a href="./code/06-dummy.r">06-dummy.r</a> を確認してみよう</li>

</ul>

<div class="slide-footer"><br></div>
</section>
</section>
<section>
<section id="slide-org678d83e">
<h2 id="org678d83e">car package の紹介</h2>
<div class="outline-text-2" id="text-org678d83e">
</div>
<div class="slide-footer"><br></div>
</section>
<section id="slide-orgd2737e0">
<h3 id="orgd2737e0">さまざまな評価</h3>
<ul>
<li>回帰モデルの評価
<ul>
<li>与えられたデータの再現</li>
<li>新しいデータの予測</li>

</ul></li>
<li><p>
モデルの再構築のための視覚化
</p>
<ul>
<li><b>residual plots</b>: 
説明変数・予測値と残差の関係</li>
<li><b>marginal-model plots</b>:
説明変数と目的変数・モデルの関係</li>
<li><b>added-variable plots</b>:
説明変数・目的変数をその他の変数で回帰したときの残差の関係</li>
<li><b>component+residual plots</b>:
説明変数とそれ以外の説明変数による残差の関係</li>

</ul>

<p>
などが用意されている
</p></li>

</ul>
<div class="slide-footer"><br></div>
</section>
<section id="slide-orge49b710" data-background="#EEEEFF">
<h3 id="orge49b710">演習: car package の使用例</h3>
<ul>
<li><a href="./code/06-car.r">06-car.r</a> を確認してみよう</li>

</ul>

<div class="slide-footer"><br></div>
</section>
<section id="slide-orgee211f9" data-background="#EEEEFF">
<h3 id="orgee211f9">演習</h3>
<ul>
<li>これまでに用いたデータでモデルを更新して評価してみよう
<ul>
<li>変数間の線形回帰の関係について仮説を立てる</li>
<li>モデルのあてはめを行い評価する
<ul>
<li>説明力があるのか? (\(F\) -統計量，\(t\) -統計量，決定係数)</li>
<li>残差に偏りはないか? (様々な診断プロット)</li>
<li>変数間の線形関係は妥当か? (様々な診断プロット)</li>

</ul></li>
<li>検討結果を踏まえてモデルを更新する (評価の繰り返し)</li>

</ul></li>

</ul>
<div class="slide-footer"><br></div>
</section>
</section>
</div>
</div>
<script src="./reveal.js/dist/reveal.js"></script>
<script src="./reveal.js/plugin/notes/notes.js"></script>
<script src="./reveal.js/plugin/search/search.js"></script>
<script src="./reveal.js/plugin/zoom/zoom.js"></script>
<script src="./reveal.js/plugin/highlight/highlight.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: true,
center: true,
slideNumber: 'c',
rollingLinks: false,
keyboard: true,
mouseWheel: true,
fragmentInURL: true,
hashOneBasedIndex: false,
pdfSeparateFragments: false,

overview: true,

transition: 'fade',
transitionSpeed: 'default',
chalkboard: { toggleChalkboardButton: { left: '80px' }, toggleNotesButton: { left: '130px'}}, keyboard: { 69: function() { RevealChalkboard.toggleNotesCanvas() }, 87: function() { RevealChalkboard.toggleChalkboard() }, 67: function() { RevealChalkboard.clear() }, 82: function() { RevealChalkboard.reset() }, 68: function() { RevealChalkboard.download() }, 88: function() { RevealChalkboard.colorNext() }, 89: function() { RevealChalkboard.colorPrev() }},

// Plugins with reveal.js 4.x
plugins: [ RevealNotes, RevealSearch, RevealZoom, RevealHighlight ],

// Optional libraries used to extend reveal.js
dependencies: [
{ src: './reveal.js/plugin/menu/menu.js'},
{ src: './reveal.js/plugin/chalkboard/chalkboard.js'}]

});
</script>
</body>
</html>
